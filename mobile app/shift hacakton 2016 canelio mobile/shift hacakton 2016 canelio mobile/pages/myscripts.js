App.controller("ctrl_FilesDownload",function($q,$cordovaFile,$window){console.log("in ctrl files download");var data={id:"jedinica"};var blob=new Blob([JSON.stringify(data)],{type:'application/json'});console.log($window.cordova.file.dataDirectory);$cordovaFile.createDir('groups').then(function(sucess){console.log("dir sucessfully created");console.log(sucess);$cordovaFile.writeFile('groups/2.json',blob,{'append':!1}).then(function(result){console.log("writing sucess");$cordovaFile.readAsText('groups/2.json').then(function(sucess){console.log("sucess reading file");console.log(JSON.parse(sucess).id)},function(error){console.log(error.code);if(error.code=1){console.log("file doesnt exist")}})},function(err){console.log(err);console.log("writing error")})},function(error){console.log(error)})});App.controller("bleTest",function($scope,db_Trainig,$q){var heartRate={service:'C033',measurement:'C034'};var app={linesGot:0,initialize:function(){this.bindEvents()},bindEvents:function(){document.addEventListener('deviceready',this.onDeviceReady,!1)},onDeviceReady:function(){app.scan()},scan:function(){app.status("Scanning for Heart Rate Monitor");var foundHeartRateMonitor=!1;function onScan(peripheral){console.log("Found "+JSON.stringify(peripheral));foundHeartRateMonitor=!0;ble.connect(peripheral.id,app.onConnect,app.onDisconnect)}
function scanFailure(reason){alert("BLE Scan Failed")}
ble.scan([],5,onScan,scanFailure);setTimeout(function(){},5000)},onConnect:function(peripheral){app.status("Connected to "+peripheral.id);alertify.success("connected");app.peripheralId=peripheral.id;ble.startNotification(peripheral.id,heartRate.service,heartRate.measurement,app.onData,app.onError);$scope.sendData1();app.firstData=!0;app.firstDate=new Date()},onDisconnect:function(reason){alertify.success("disconnected");beatsPerMinute.innerHTML="...";app.status("Disconnected")},tricks:[],onData:function(buffer){app.linesGot++;var data=new Uint8Array(buffer);beatsPerMinute.innerHTML=data[1];var position=0;var tricks=[];for(var i=0;i<20;i=i+5){if(data[i]==0&&data[i+1]==0&&data[i+2]==0&&data[i+3]==0&&data[i+4]==0){break}
var trick={trained:(data[i+1]%16)*256+data[i+2],success:data[i]*256+data[i+1]/16,trickId:data[i+3]/8,totalHours:(data[i+3]%8)*256+data[i+4]}
app.tricks.push(trick)}
console.log(data);if(!app.firstData){}else{clearTimeout(app.timeout);app.timeout=setTimeout(function(){var endDate=new Date();var time=endDate.getTime()-app.firstDate.getTime()-1000;console.log("total time is:",time)},1000)}},onError:function(reason){alert("There was an error "+reason)},status:function(message){console.log(message);statusDiv.innerHTML=message}};$scope.printLinesGot=function(){alertify.success(app.linesGot)}
app.initialize();function onWrite(){alertify.success("written")}
function onWriteFail(){alertify.error("failed to write")}
$scope.sendData=function(){console.log(app.tricks)}
$scope.sendData1=function(){var data=new Uint8Array([24,52,56,6,22,24,182,178,186,67,97,78,101,76,105,79,59,0,0,0]);ble.write(app.peripheralId,heartRate.service,heartRate.measurement,data.buffer,onWrite,onWriteFail)}
$scope.sendData2=function(){var data=new Uint32Array([3333]);ble.write(app.peripheralId,heartRate.service,heartRate.measurement,data.buffer,onWrite,onWriteFail)}
setTimeout(function(){app.onDeviceReady()},1000)});App.controller("bleRead",function($scope,db_Trainig,$q){'use strict';var battery={service:"180F",level:"2A19"};var app={initialize:function(){this.bindEvents();detailPage.hidden=!0},bindEvents:function(){document.addEventListener('deviceready',this.onDeviceReady,!1);refreshButton.addEventListener('touchstart',this.refreshDeviceList,!1);batteryStateButton.addEventListener('touchstart',this.readBatteryState,!1);disconnectButton.addEventListener('touchstart',this.disconnect,!1);deviceList.addEventListener('touchstart',this.connect,!1)},onDeviceReady:function(){app.refreshDeviceList()},refreshDeviceList:function(){deviceList.innerHTML='';ble.scan([],5,app.onDiscoverDevice,app.onError)},onDiscoverDevice:function(device){console.log(JSON.stringify(device));var listItem=document.createElement('li'),html='<b>'+device.name+'</b><br/>'+'RSSI: '+device.rssi+'&nbsp;|&nbsp;'+device.id;listItem.dataset.deviceId=device.id;listItem.innerHTML=html;deviceList.appendChild(listItem)},connect:function(e){var deviceId=e.target.dataset.deviceId,onConnect=function(){batteryStateButton.dataset.deviceId=deviceId;disconnectButton.dataset.deviceId=deviceId;app.showDetailPage()};ble.connect(deviceId,onConnect,app.onError)},onBatteryLevelChange:function(data){console.log(data);var message;var a=new Uint8Array(data);batteryState.innerHTML=a[0]},readBatteryState:function(event){console.log("readBatteryState");var deviceId=event.target.dataset.deviceId;ble.read(deviceId,battery.service,battery.level,app.onReadBatteryLevel,app.onErrorRead);setTimeout(function(){app.readBatteryState(event)},1)},onErrorRead:function(e){console.log(e);alertify.error("read failled")},onReadBatteryLevel:function(data){console.log(data);var message;var a=new Uint8Array(data);batteryState.innerHTML=a[0];console.log(a[0])},disconnect:function(event){var deviceId=event.target.dataset.deviceId;ble.disconnect(deviceId,app.showMainPage,app.onError)},showMainPage:function(){mainPage.hidden=!1;detailPage.hidden=!0},showDetailPage:function(){mainPage.hidden=!0;detailPage.hidden=!1},onError:function(reason){alert("ERROR: "+reason)}};app.initialize();setTimeout(function(){app.onDeviceReady()},1000)});App.factory("dateHelper",function(){function getCurrentDate(inDateFormat){return kendo_DateHelper.getCurrentDate(inDateFormat)}
function getDateMinusDays(days,inDateFormat){return kendo_DateHelper.getDateMinusDays(days,inDateFormat)}
function formatDateForDb(date){return kendo_DateHelper.formatDateForDb(date)}
function getCurrentTimestamp(){return kendo_DateHelper.getCurrentTimestamp()}
return{getCurrentDate:getCurrentDate,getDateMinusDays:getDateMinusDays,formatDateForDb:formatDateForDb,getCurrentTimestamp:getCurrentTimestamp,}});(function($,console,win){function pad(number){if(number<10){return '0'+number}
return number}
var $scope={getCurrentDate:function(inDateFormat){var date=new Date();if(inDateFormat){return date}
return $scope.formatDateForDb(date)},getDateMinusDays:function(days,inDateFormat){var d=new Date()-1000*60*60*24*days;d=new Date(d);if(inDateFormat){return d}
return $scope.formatDateForDb(d)},calculateDateMinusDays:function(date,days,inDateFormat){var d=date-1000*60*60*24*days;d=new Date(d);if(inDateFormat){return d}
return $scope.formatDateForDb(d)},formatDateForDb:function(date){var str=date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate());return str},getCurrentTimestamp:function(){var date=new Date();var str=date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate())+' '+pad(date.getHours())+':'+pad(date.getMinutes())+':'+pad(date.getSeconds());return str},getTimestampFromDate:function(date){var str=date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate())+' '+pad(date.getHours())+':'+pad(date.getMinutes())+':'+pad(date.getSeconds());return str},getDateFromIsoFormat:function(dbDate){var dateParts=dbDate.split("-");var jsDate=new Date(dateParts[0],dateParts[1]-1,dateParts[2].substr(0,2));return jsDate}};$.extend(window,{kendo_DateHelper:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={daysBetween:function(startDate,endDate){var start=moment(startDate,$scope.inputFormat());var end=moment(endDate,$scope.inputFormat());var days=start.diff(end,"days");if(days==0){return '1 day'}else{return days+1+' days'}},inputFormat:function(){return "YYYY-MM-DD"}};$.extend(window,{kendo_DateCalculationsHelper:$scope,})})(jQuery,console,window);App.factory("requestHelper",function($q,$http){function post(def,data,firstTry){window.kendo_RequestHelper.post(def,data,firstTry)}
return{post:post}});(function($,console,win){var kendo_RequestHelper={post:function(def,data,firstTry){firstTry=typeof firstTry!=='undefined'?firstTry:!0;data.token=window.localStorage.getItem('token');var originalData=data;$.ajax({type:"POST",url:VAR_SERVER,data:data,success:function(data,status,headers,config){data=JSON.parse(data);if(data.success==1){def.resolve(data.data)}else{if(!firstTry){def.reject({message:data.message,errorCode:data.errorCode})}else{var def2=$.Deferred()
def2.promise().then(function(def2Data){kendo_RequestHelper.post(def,originalData,!1)},function(error){def.reject({message:data.message,errorCode:data.errorCode})});var $body=angular.element(document.body);var $model_Login=$body.injector().get('model_Login');$model_Login.relog(def2)}}},error:function(data,status){def.reject(data)}})}};$.extend(window,{kendo_RequestHelper:kendo_RequestHelper,})})(jQuery,console,window);(function($,console,win){var $scope={getChartConfig:function(){var config={legend:{visible:!0,position:"top",labels:{font:"18px",margin:{right:20,},padding:{top:5,bottom:5}}},seriesColors:SERIES_COLORS,valueAxis:{line:{visible:!1,},majorGridLines:{color:"#bbb"},minorGridLines:{color:"#000000",visible:!1},},categoryAxis:{field:"date",majorGridLines:{visible:!1},line:{visible:!1,},labels:{rotation:90},},chartArea:{background:"transparent",},tooltip:{visible:!1,},theme:"flat"};return config},getSucessRateConfig:function(){var config=$scope.getChartConfig();config.series=[{name:"Success Rate %",field:"successRate",color:"#134787",type:"area"},{name:"Success Rate blue line",type:"line",field:"successRate",color:"#062244",visibleInLegend:!1,markers:{background:"#062244"}}];config.valueAxis.labels={template:"#:value#%"}
config.valueAxis.max=105;config.valueAxis.min=0;config.legendItemClick=function(e){e.preventDefault()}
return config},d3SuccessConfig:function(height){var config={xIsMysqlDate:!0,xField:"date",yField:"successRate",element:'#successChart',curved:!1,height:height,seeMaxTick:!0,areaFillColor:'#134787',areaFillOpacity:'0.8',lineColor:'#062244',lineWidth:'2',yLabelFormat:function(howManyDecimals){return function(v,i){return v.toFixed(howManyDecimals)+' %'}}}
return config},d3RepetitionsConfig:function(height){var config={xIsMysqlDate:!0,xField:"date",yField:"fail",yField2:"success",element:'#repetitionsChart',curved:!1,roundXTicks:!0,height:height,seeMaxTick:!0,areaFillColor:'#871326',areaFillOpacity:'0.8',areaFillColor2:'#134787',areaFillOpacity2:'0.8',lineColor:'#900112',lineWidth:'2',lineColor2:'#062244',lineWidth2:'2',yLabelFormat:function(howManyDecimals){return function(v,i){return v.toFixed(howManyDecimals)+' rep'}}}
return config}};$.extend(window,{kendo_ChartHelper:$scope,})})(jQuery,console,window);App.factory("arrayHelper",function(){function formatTrickSatistics(data){var repetitions=[];var sucessRates=[];var totalSuccess=0;var totalFailed=0;var highestSucessRate=0;for(var i=0;data.length>i;i++){var rep={};rep.success=parseInt(data[i].success);rep.fail=data[i].total-data[i].success;rep.date=data[i].date;totalSuccess+=rep.success;totalFailed+=rep.fail;repetitions.push(rep);var success={};success.successRate=Math.round((data[i].success/data[i].total)*100);success.date=data[i].date;highestSucessRate=highestSucessRate>success.successRate?highestSucessRate:success.successRate;sucessRates.push(success)}
console.log(repetitions);return{repetitions:repetitions,sucessRates:sucessRates,totalSuccess:totalSuccess,totalFailed:totalFailed,highestSucessRate:highestSucessRate}}
return{formatTrickSatistics:formatTrickSatistics}});App.factory("chartHelper",function(){function getChartConfig(){return kendo_ChartHelper.getChartConfig()}
return{getChartConfig:getChartConfig}});App.factory("stringHelper",function(){function formatWith3Dots(string,nmChars,widthForChars,realWidth){var maxNmChars=Math.round(realWidth*(nmChars/widthForChars));var returned=string.length>maxNmChars?string.substring(0,maxNmChars-3)+'...':string;return returned}
function replaceSpaces(string){return string.replace(new RegExp('%20','g'),' ')}
return{formatWith3Dots:formatWith3Dots,replaceSpaces:replaceSpaces}});App.factory("svc_File",function($q,$cordovaFile,$window,$location){function getFile(deferred,filePath){$cordovaFile.readAsText(VAR_MOBILE_FOLDER+filePath).then(function(sucess){deferred.resolve(sucess)},function(error){deferred.reject()})}
function getFileJson(deferred,filePath,blockRedirect){$cordovaFile.readAsText(VAR_MOBILE_FOLDER+filePath).then(function(sucess){console.log("__________________________________________");console.log(JSON.parse(sucess));deferred.resolve(JSON.parse(sucess))},function(error){console.log(error);deferred.reject();if(typeof blockRedirect=="undefined"){}})}
function getAllTrickGroups(deferred){getFileJson(deferred,'groups/all.json')}
function getTrickGroup(deferred,id){getFileJson(deferred,'groups/'+id+'.json')}
function getTrickSubGroup(deferred,id){getFileJson(deferred,'subgroups/'+id+'.json')}
function getTrick(deferred,id){getFileJson(deferred,'tricks/'+id+'.json')}
function getTrickSolution(deferred,id){getFileJson(deferred,'tricks/'+id+'solution.json')}
return{getFile:getFile,getFileJson:getFileJson,getAllTrickGroups:getAllTrickGroups,getTrickGroup:getTrickGroup,getTrickSubGroup:getTrickSubGroup,getTrick:getTrick,getTrickSolution:getTrickSolution,}});App.factory("svc_FileChecker",function($q,svc_File,$location,$rootScope){function checkFilesVersion(){var version=localStorage.getItem('filesVersion');console.log("version");console.log(version);console.log(typeof version);if(typeof version=="undefined"||version==null){console.log("location should be files download");$location.path('/filesDownload/1')}else{version=JSON.parse(version);$location.path("/clicker/Connect")}}
return{checkFilesVersion:checkFilesVersion}});(function($,console,win){var routes=localStorage.getItem("kendoRoutes");if(routes==null||routes==""){localStorage.setItem("kendoRoutes","[]")}
var $scope={app:null,setApp:function(app){$scope.app=app},destroyApp:function(e){$scope.app=null},navigateAngular:function(path,transition){var $body=angular.element(document.body);var $rootScope=$body.scope().$root;$rootScope.angNavigate(path,transition)},navigateBack:function(){var lastRoute=$scope.popRoute();var transition="slide:left reverse";if(lastRoute.transition){transition=lastRoute.transition+' reverse'}
if(lastRoute=="history"){$scope.popRoute();var $body=angular.element(document.body);var $rootScope=$body.scope().$root;var injector=$body.injector();var $location=injector.get('$location');$rootScope.$apply(function(){$rootScope.goBack($rootScope,$location,!0)})}else{var url=$scope.constructRoute(lastRoute.view,lastRoute.params);$scope.app.navigate(url,transition)}},navigate:function(view,params,transition){if(transition==null){transition=="slide:left"}
var route={'view':view,"params":params,"transition":transition,};$scope.pushRoute(route);var url=$scope.constructRoute(view,params);$scope.app.navigate(url,transition)},pushRoute:function(route){var routes=JSON.parse(localStorage.getItem("kendoRoutes"));routes.push(route);localStorage.setItem("kendoRoutes",JSON.stringify(routes))},popRoute:function(){var routes=JSON.parse(localStorage.getItem("kendoRoutes"));routes.pop();localStorage.setItem("kendoRoutes",JSON.stringify(routes));if(routes.length>0){return routes[routes.length-1]}else{return null}},getRoutes:function(){return JSON.parse(localStorage.getItem("kendoRoutes"))},constructRoute:function(url,params){first=!0;var stringParams="";for(var paramName in params){if(first){stringParams=""+paramName+'='+params[paramName];first=!1}else{stringParams=stringParams+"&"+paramName+'='+params[paramName]}}
return url+'?'+stringParams},setFirstView:function(view,params,transition){var route={'view':view,"params":params,"transition":transition,};$scope.pushRoute("history");$scope.pushRoute(route)},getFirstView:function(){var routes=JSON.parse(localStorage.getItem("kendoRoutes"));last=routes[routes.length-1];return $scope.constructRoute(last.view,last.params)}};$.extend(window,{kConnector:$scope,})})(jQuery,console,window);(function($,console,win){var routes=localStorage.getItem("angRoutes");if(routes==null||routes==""){localStorage.setItem("angRoutes","[]")}
var $scope={routes:[],ignoreNextRoute:!1,currentRoute:null,addRoute:function(route){if($scope.ignoreNextRoute){$scope.ignoreNextRoute=!1;return null}
var hashPos=route.indexOf('#');var location=route.substring(hashPos+1,route.length);$scope.routes=JSON.parse(localStorage.getItem("angRoutes"));$scope.routes.push(location);localStorage.setItem("angRoutes",JSON.stringify($scope.routes));$scope.currentRoute=route},getBackRoute:function(){$scope.routes=JSON.parse(localStorage.getItem("angRoutes"));$scope.currentRoute=$scope.routes.pop();$scope.ignoreNextRoute=!0;localStorage.setItem("angRoutes",JSON.stringify($scope.routes));return $scope.routes[$scope.routes.length-1]},checkRoute:function(route){if($scope.currentRoute.indexOf('/main')>-1){return !1}else if($scope.currentRoute.indexOf('/notSignedIn')>-1){return !1}else if($scope.currentRoute.indexOf('/resultUpload')>-1){return !1}else if($scope.currentRoute.indexOf('/clicker/Connect')>-1){return !1}else if($scope.currentRoute.indexOf('/downloadClicker')>-1){return !1}else if($scope.currentRoute.indexOf('/uploadToServer')>-1){return !1}
return !0},goBack:function($rootScope,$location,isFromKendo){$scope.routes=JSON.parse(localStorage.getItem("angRoutes"));$scope.currentRoute=$scope.routes[$scope.routes.length-1];if(!isFromKendo&&$scope.currentRoute.indexOf('/kendo')>-1){kConnector.navigateBack();return !1}
if(!svc_AngularHistory.checkRoute(prevRoute)){return !1}
$scope.currentRoute=$scope.routes.pop();$scope.ignoreNextRoute=!0;localStorage.setItem("angRoutes",JSON.stringify($scope.routes));var prevRoute=$scope.routes[$scope.routes.length-1];if($rootScope.$$phase){$location.path(prevRoute)}else{$rootScope.$apply(function(){$location.path(prevRoute)})}},clearRoutes:function(){if($scope.routes.length>2){$scope.routes=$scope.routes.splice($scope.routes.length-2,$scope.routes.length-1);localStorage.setItem("angRoutes",JSON.stringify($scope.routes))}
var kendoRoutes=JSON.parse(localStorage.getItem("kendoRoutes"));if(kendoRoutes.length>2){kendRoutes=kendoRoutes.splice(kendoRoutes.length-2,kendoRoutes.length-1);localStorage.setItem("kendoRoutes",JSON.stringify(kendoRoutes))}}};$.extend(window,{svc_AngularHistory:$scope,})})(jQuery,console,window);App.factory("model_Register",function($q,$http,model_Login){function register(def,data){var obj={"class":"user","method":"register","data":data}
var defer=$q.defer();defer.promise.then(function(data){model_Login.saveData(data);def.resolve(!0)},function(error){def.reject(error)});kendo_RequestHelper.post(defer,obj,!1)}
function resetPassword(def,data){var obj={"class":"user","method":"passRetrivalByEmail","data":data}
kendo_RequestHelper.post(def,obj,!1)}
return{register:register,resetPassword:resetPassword}});App.factory("model_Login",function($q,$cordovaFile,$window,$location,$http,model_Dog,model_Goal,model_Level,db_Manager,db_Sync){function login(def,data){data.fetchData=!0;var days=model_Goal.getImportantDays();data.weeklyDayStart=days.weeklyDayStart;data.weeklyDayEnd=days.weeklyDayEnd;data.dailyToday=days.dailyToday;var obj={"class":"user","method":"login","data":data}
var defer=$q.defer();defer.promise.then(function(data){console.log("login failed");saveData(data,!0);def.resolve(!0)},function(error){console.log("saving data failed");def.reject(error)});kendo_RequestHelper.post(defer,obj)}
function refreshData(def){var data={};data.email=window.localStorage.getItem("email");data.password=window.localStorage.getItem("password");data.relog=!0;login(def,data)}
function relog(def){console.log("relog called--------------------------------");var obj={"class":"user","method":"login","data":{relog:!0,password:localStorage.getItem('password'),email:localStorage.getItem('email')}}
var defer=$q.defer();defer.promise.then(function(data){saveData(data,!1);def.resolve(!0)},function(error){def.reject(!1)});kendo_RequestHelper.post(defer,obj,!1)}
function saveToken(token){window.localStorage.setItem('token',token)}
function saveData(data){window.localStorage.setItem('token',data.token);window.localStorage.setItem('email',data.email);window.localStorage.setItem('password',data.password);window.localStorage.setItem('dogName',data.dogName);if(data.userLevel){model_Level.updateLevel(data)}
if(data.imageSmall){model_Dog.saveDogImage(data.imageSmall)}
if(data.tricks){}
if(data.dailyGoal||data.weeklyGoal){model_Goal.updateGoalsDataFromServer(data)}
if(data.title){window.localStorage.setItem('dogTitle',data.title)}}
function clearData(){window.localStorage.removeItem('dogName');window.localStorage.removeItem('token');window.localStorage.removeItem('email');window.localStorage.removeItem('password');model_Dog.deleteDogImage();window.localStorage.removeItem('tricks');window.localStorage.removeItem('filesVersion')
window.localStorage.removeItem("serverSyncRequired");window.localStorage.removeItem('tutorialGoals');window.localStorage.removeItem('tutorialTricks');window.localStorage.removeItem('dogTitle')
model_Goal.clearGoals();model_Level.clearLevel();window.localStorage.removeItem('clickerSyncTime');window.localStorage.removeItem('clickerSyncRequired');window.localStorage.removeItem('s1');window.localStorage.removeItem('s2');window.localStorage.removeItem("clickerDontSyncOnStart")}
return{login:login,saveToken:saveToken,saveData:saveData,clearData:clearData,relog:relog,refreshData:refreshData}});App.factory("model_Train",function($q,$http,requestHelper,model_GoalDaily,model_Level,db_Trainig,model_ServerSync,db_TrainingForServer){function train(def,data){console.log(data);data.dateTimeTrained=data.dateTimeTrained.substr(0,14)+'00:00';model_Level.updatePoints(data);var obj={"class":"training","method":"train","data":data}
var def2=$q.defer();def2.promise.then(function(success){def.resolve(success)},function(){console.log("resolved fail");console.log(data);var trainingForSeverData={time:moment(data.dateTimeTrained).unix(),timesSuccess:data.timesSuccess,timesTrained:data.timesTrained,trick_id:data.trick_id}
console.log("insert data");console.log(trainingForSeverData);var def3=$q.defer();db_TrainingForServer.insertTrainingSingleRep(def3,[trainingForSeverData]);model_ServerSync.setSync();db_Trainig.todayTrickStatistics(def,data)});console.log("senidng obj-----------");console.log(obj);db_Trainig.insertTraining(data);if(model_ServerSync.isSyncNeeded()){console.log("should reject");def2.reject()}else{requestHelper.post(def2,obj)}}
function saveTrainingOffline(){}
return{train:train,saveTrainingOffline:saveTrainingOffline}});App.factory("model_TrickStatistics",function($q,$http,requestHelper,db_Trainig){function getData(def,data){db_Trainig.trickStatisticsData(def,data)}
function getTodayTraining(def,data){db_Trainig.todayTrickStatistics(def,data)}
function formatTrickSatistics(data){return kmodel_TrickStatistics.formatTrickSatistics(data)}
return{getData:getData,getTodayTraining:getTodayTraining,formatTrickSatistics:formatTrickSatistics}});App.factory("model_GroupStatistics",function($q,$http,requestHelper){function getData(def,level,data){var obj={"class":"statistics","data":data}
if(level=="subgroup"){obj.method="getSubGroupData"}else if(level=="group"){obj.method="getGroupData"}
requestHelper.post(def,obj)}
function formatGroupSatistics(ctrlDef,filePromise,level,data){filePromise.then(function(fileData){if(data.length==0){ctrlDef.reject("noData");return null}
var totalValues={};var totalDone=0;var trainings=[];var workingDate="",highestSucessRate=0,totalSuccess=0,totalFail=0,dayTraining;for(var i=0;data.length>i;i++){if(typeof totalValues[data[i].trick_id]=="undefined"){totalValues[data[i].trick_id]=0}
totalValues[data[i].trick_id]+=parseInt(data[i].total);totalDone+=parseInt(data[i].total);if(workingDate!==data[i].date){if(typeof dayTraining!="undefined"){dayTraining.date=workingDate;dayTraining.successRate=Math.round((dayTraining.success/dayTraining.total)*100);highestSucessRate=highestSucessRate>dayTraining.successRate?highestSucessRate:dayTraining.successRate;totalSuccess+=dayTraining.success;totalFail+=dayTraining.fail;trainings.push(dayTraining);dayTraining={success:0,fail:0,total:0}}else{dayTraining={success:0,fail:0,total:0}}
workingDate=data[i].date}
dayTraining.success+=parseInt(data[i].success);dayTraining.fail+=parseInt(data[i].total)-parseInt(data[i].success);dayTraining.total+=parseInt(data[i].total)}
dayTraining.date=workingDate;dayTraining.successRate=Math.round((dayTraining.success/dayTraining.total)*100);highestSucessRate=highestSucessRate>dayTraining.successRate?highestSucessRate:dayTraining.successRate;totalSuccess+=dayTraining.success;totalFail+=dayTraining.fail;trainings.push(dayTraining);var shares=[];var formattedFileData=formatFile(level,fileData);angular.forEach(totalValues,function(value,key){var share={};if(typeof formattedFileData[key]=="undefined"){share.name="NONE -- please update app"}else{share.name=formattedFileData[key]}
share.value=value;share.percentage=Math.round((share.value/totalDone)*100);shares.push(share)});ctrlDef.resolve({shares:shares,trainings:trainings,highestSucessRate:highestSucessRate,totalFail:totalFail,totalSuccess:totalSuccess,})})}
function formatFile(lvl,data){if(lvl==="subgroup"){return formatSubGroupFile(data)}else if(lvl==="group"){return formatGroupFile(data)}};function formatGroupFile(data){var ar=[];var tricks=data.subGroups;for(var i=0;i<tricks.length;i++){if(typeof tricks[i].id!="undefined"){ar[tricks[i].id]=tricks[i].name}else{ar[tricks[i].trickId]=tricks[i].name}}
return ar}
function formatSubGroupFile(data){var ar=[];var tricks=data.tricks;for(var i=0;i<tricks.length;i++){ar[tricks[i].id]=tricks[i].name}
return ar}
return{getData:getData,formatGroupSatistics:formatGroupSatistics}});App.factory("model_DownloadFiles",function($q,$http,requestHelper,$cordovaFile){function getFullFilesList(def,data){var obj={"class":"files","method":"getFullList","data":data}
requestHelper.post(def,obj)}
function createCanelioFolder(def){$cordovaFile.checkDir(VAR_MOBILE_FOLDER_SINGLE).then(function(success){def.resolve(!0)},function(fail){$cordovaFile.createDir(VAR_MOBILE_FOLDER_SINGLE).then(function(sucess){def.resolve(!0)},function(error){def.reject(!1)})})}
function createFolder(def,name){console.log("create folder",name);$cordovaFile.createDir(VAR_MOBILE_FOLDER+name).then(function(sucess){def.resolve(!0)},function(error){def.reject(!1)})}
function createImage(def,fileName,data){var path=VAR_MOBILE_FOLDER+fileName;var grantedBytes=0;var text=data;window.requestFileSystem(LocalFileSystem.PERSISTENT,grantedBytes,function(fileSystem){_createFile(fileSystem,fileName,text,onSuccess,onError,path,def,!1)},function(error){alertify.error("Failed creating file.")})}
function createFile(def,dir,fileName,data){var path=VAR_MOBILE_FOLDER+dir+'/'+fileName+'.json';var grantedBytes=0;var text=JSON.stringify(data);console.log("local file system persistnent");console.log(LocalFileSystem.PERSISTENT);window.requestFileSystem(LocalFileSystem.PERSISTENT,grantedBytes,function(fileSystem){console.log("file system result");console.log(fileSystem);_createFile(fileSystem,fileName,text,onSuccess,onError,path,def,!0)},function(error){alertify.error("Failed creating file.")})}
function onSuccess(){alertify.success("resolved")}
function onError(){alertify.error("error")}
function _createFile(fileSystem,fileName,text,onSuccess,onError,path,def,addNewLine){var options={create:!0,exclusive:!1};fileSystem.root.getFile(path,options,function(fileEntry){console.log("file entry is");console.log(fileEntry);_createFileWriter(fileEntry,text,onSuccess,onError,def,addNewLine)},function(error){alertify.error("Failed creating file.")})};function _createFileWriter(fileEntry,text,onSuccess,onError,def,addNewLine){var that=this;fileEntry.createWriter(function(fileWriter){var len=fileWriter.length;fileWriter.seek(0);if(addNewLine){fileWriter.write(text+'\n')}else{fileWriter.write(text)}
var message="Wrote: "+text;console.log("resolving true");def.resolve(!0)},function(error){alertify.error("Failed creating writer.")})};return{getFullFilesList:getFullFilesList,createFile:createFile,createFolder:createFolder,createCanelioFolder:createCanelioFolder,createImage:createImage}});App.factory("model_Result",function($q,$http,requestHelper,$rootScope,$location,model_UploadDogImage){var data={timesSuccess:20,timesTrained:30};function navigateResultOrAchievment(d,trickId,simple){console.log("data is:",d);data=d;if(data.data.achivementWon){model_UploadDogImage.resetImages();$rootScope.navigateNoNavBarTransition("/achievementWon/"+trickId+'/'+data.data.achivementId)}else if(!simple){$rootScope.navigateNoNavBarTransition("/result/1/"+trickId)}}
function getTrainingResult(){var returned=calculatePointsAndSuccessRate(data);returned.achivementWon=data.achivementWon;var messages;messages=['cool!','Nicely done!','Huurah!','On your way!','You can do this!',"Nice!","Very well!","Good!","Nice training!","Bravo!",'Sky is limit!'];returned.message=messages[Math.floor(Math.random()*messages.length)];return returned}
function calculatePointsAndSuccessRate(data){var returned={};returned.successRate=Math.round((data.timesSuccess/data.timesTrained)*100);var success=parseInt(data.timesSuccess);var fail=parseInt(data.timesTrained)-parseInt(data.timesSuccess);returned.points=kmodel_Points.calculatePoints(success,fail)
return returned}
function getAchievmentMessage(){var messages=["Woow!","Amazing!","Epic!","Superb!","Magical!","Majestic!","Superior!","Congrats!",'Awesome!',"Success!"];return messages[Math.floor(Math.random()*messages.length)]}
return{getTrainingResult:getTrainingResult,calculatePointsAndSuccessRate:calculatePointsAndSuccessRate,navigateResultOrAchievment:navigateResultOrAchievment,getAchievmentMessage:getAchievmentMessage}});App.factory("model_UploadDogImage",function($q,$http,requestHelper){var images={};var config={};var imageLargeId=null;function setImages(small,big){kmodel_UploadDogImage.setImages(small,big)}
function resetImages(){kmodel_UploadDogImage.resetImages()}
function getImages(){return kmodel_UploadDogImage.getImages()}
function setConfig(c){kmodel_UploadDogImage.setConfig(c)}
function getConfig(){return kmodel_UploadDogImage.getConfig()}
function setImageLargeId(id){kmodel_UploadDogImage.setImageLargeId(id)}
function getImageLargeId(){return kmodel_UploadDogImage.getImageLargeId()}
function uploadImage(def,data){kmodel_UploadDogImage.uploadImage(def,data)}
function cropImage(def,data){kmodel_UploadDogImage.cropImage(def,data)}
function checkForEdit(def){kmodel_UploadDogImage.checkForEdit(def)}
function duplicateImage(def,data){kmodel_UploadDogImage.duplicateImage(def,data)}
return{uploadImage:uploadImage,cropImage:cropImage,duplicateImage:duplicateImage,checkForEdit:checkForEdit,setImages:setImages,resetImages:resetImages,getImages:getImages,getConfig:getConfig,setConfig:setConfig,setImageLargeId:setImageLargeId,getImageLargeId:getImageLargeId}});App.factory("model_Gallery",function($q,requestHelper){function getDogImages(def,data){var obj={"class":"dog_images","method":"getImages","data":data}
requestHelper.post(def,obj)}
function getSizeDogImages(def,data){var obj={"class":"dog_images","method":"numberOfImages","data":data}
requestHelper.post(def,obj)}
return{getDogImages:getDogImages,getSizeDogImages:getSizeDogImages}});App.factory("model_Achivement",function($q,$http,requestHelper){function achivementsNumber(def,data){var obj={"class":"achievment","method":"numberOfAchivements","data":data}
requestHelper.post(def,obj)}
function getAchivements(def,data){var obj={"class":"achievment","method":"getAchivements","data":data}
requestHelper.post(def,obj)}
return{achivementsNumber:achivementsNumber,getAchivements:getAchivements}});(function($,console,win){var $scope={achivmentLevel:function(def,data){var obj={"class":"achievment","method":"achivmentLevel","data":data}
kendo_RequestHelper.post(def,obj)},achivementsNumber:function(def,data){var obj={"class":"achievment","method":"numberOfAchivements","data":data}
kendo_RequestHelper.post(def,obj)},getAchivements:function(def,data){var obj={"class":"achievment","method":"getAchivements","data":data}
kendo_RequestHelper.post(def,obj)},getAchivementForTrick:function(def,data){var obj={"class":"achievment","method":"getAchivementForTrick","data":data}
kendo_RequestHelper.post(def,obj)},getTitleForLevel:function(lvl,trickName){if(lvl==0){return 'Beginner of '+trickName}else if(lvl==1){return 'Sargent of '+trickName}else if(lvl==2){return 'Defender of '+trickName}else if(lvl==3){return 'Master of '+trickName}else if(lvl==4){return 'Jedi of '+trickName}},getAchivmentId:function(def,data){var obj={"class":"achievment","method":"getAchivmentId","data":data}
kendo_RequestHelper.post(def,obj)}};$.extend(window,{kmodel_Achivement:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={formatTrickSatistics:function(data){var repetitions=[];var sucessRates=[];var totalSuccess=0;var totalFailed=0;var highestSucessRate=0;for(var i=0;data.length>i;i++){var rep={};rep.success=parseInt(data[i].success);rep.fail=data[i].total-data[i].success;rep.date=data[i].date;totalSuccess+=rep.success;totalFailed+=rep.fail;repetitions.push(rep);var success={};success.successRate=Math.round((data[i].success/data[i].total)*100);success.date=data[i].date;highestSucessRate=highestSucessRate>success.successRate?highestSucessRate:success.successRate;sucessRates.push(success)}
console.log(repetitions);return{repetitions:repetitions,sucessRates:sucessRates,totalSuccess:totalSuccess,totalFailed:totalFailed,highestSucessRate:highestSucessRate}},getStatistic:function(def,data){var obj={"class":"statistics","method":"getDates","data":data}
kendo_RequestHelper.post(def,obj)}};$.extend(window,{kmodel_TrickStatistics:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={calculatePoints:function(success,fail){return parseInt(success)*2+parseInt(fail)}};$.extend(window,{kmodel_Points:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={images:{},config:{},imageLargeId:null,getConfig:function(){return $scope.config},setConfig:function(c){$scope.config=c},setImages:function(small,big){$scope.images.small=small;$scope.images.big=big;if($scope.config.type=="profile"){var $body=angular.element(document.body);var $model_Dog=$body.injector().get('model_Dog');$model_Dog.saveDogImage(small)}},resetImages:function(){$scope.images={}},getImages:function(){return $scope.images},setConfig:function(c){$scope.config=c},getConfig:function(){return $scope.config},setImageLargeId:function(id){$scope.imageLargeId=id},getImageLargeId:function(){var id=$scope.imageLargeId;$scope.imageLargeId=null;return id},uploadImage:function(def,data){if($scope.config.type=="achivement"){var obj={"class":"trick","method":"uploadImage","data":data}
kendo_RequestHelper.post(def,obj)}else if($scope.config.type=="profile"){var obj={"class":"dog","method":"uploadImage","data":data}
kendo_RequestHelper.post(def,obj)}},cropImage:function(def,data){if($scope.config.type=="achivement"){data.trickId=$scope.config.trickId;var obj={"class":"trick","method":"cropImage","data":data}
kendo_RequestHelper.post(def,obj)}else if($scope.config.type=="profile"){var obj={"class":"dog","method":"cropImage","data":data}
kendo_RequestHelper.post(def,obj)}},checkForEdit:function(def){if($scope.config.type=="achivement"){data={trickId:$scope.config.trickId};var obj={"class":"trick","method":"hasImage","data":data}
kendo_RequestHelper.post(def,obj)}else if($scope.config.type=="profile"){var obj={"class":"dog","method":"hasImage","data":{sample:!0}}
kendo_RequestHelper.post(def,obj)}},duplicateImage:function(def,data){var obj={"class":"dog_images","method":"createFromLarge","data":data}
kendo_RequestHelper.post(def,obj)}};$.extend(window,{kmodel_UploadDogImage:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={save:function(def,weight){data={weight:weight,dateTime:kendo_DateHelper.getCurrentTimestamp()};var obj={"class":"weight","method":"saveWeight","data":data}
kendo_RequestHelper.post(def,obj)},getData:function(def,data){var obj={"class":"weight","method":"getWeightByDate","data":data}
kendo_RequestHelper.post(def,obj)},getWeighCount:function(def,data){var obj={"class":"weight","method":"getWeighCount","data":null}
kendo_RequestHelper.post(def,obj)},getWeighPaged:function(def,data){var obj={"class":"weight","method":"getWeightPaged","data":data}
console.log("sending obj");kendo_RequestHelper.post(def,obj)},deleteWeight:function(def,data){var obj={"class":"weight","method":"deleteWeight","data":data}
console.log("sending obj");kendo_RequestHelper.post(def,obj)}};$.extend(window,{kmodel_Weight:$scope,})})(jQuery,console,window);(function($,console,win){var $scope={createTrick:function(def,data){var def2=$.Deferred()
def2.promise().then(function(def2Data){var $body=angular.element(document.body);var model_Tricks=$body.injector().get('model_Tricks');var trickSaveData={id:def2Data.trickId,name:data.name}
model_Tricks.createNewTrick(def,trickSaveData)},function(error){def.reject(error)});var obj={"class":"trick","method":"createTrick","data":data}
kendo_RequestHelper.post(def2,obj)},nmTricks:function(def,data){var obj={"class":"trick","method":"numberOfTricks","data":data}
kendo_RequestHelper.post(def,obj)},getTricks:function(def,data){var obj={"class":"trick","method":"getTricks","data":data}
kendo_RequestHelper.post(def,obj)},getAllTricks:function(def,data){var obj={"class":"trick","method":"getAllTricks","data":{myTrick:1}}
kendo_RequestHelper.post(def,obj)},reorderTricks:function(def,data){var obj={"class":"trick","method":"reoderTricks","data":data}
kendo_RequestHelper.post(def,obj)},deleteTrick:function(def,data){var def2=$.Deferred()
def2.promise().then(function(def2Data){var $body=angular.element(document.body);var model_SimpleTrainMenu=$body.injector().get('model_Tricks');model_SimpleTrainMenu.deleteTrick(def,data.trick_id)},function(error){def.reject()});var obj={"class":"trick","method":"deleteTrick","data":data}
kendo_RequestHelper.post(def2,obj)},};$.extend(window,{kmodel_MyTricks:$scope,})})(jQuery,console,window);App.factory("model_Tricks",function($q,$http,requestHelper,db_Tricks,db_Sync){function getTricks(def,data){db_Tricks.getTricks(def,data)}
function getTricksFromServer(def,data){var obj={"class":"trick","method":"getAllTricks","data":{some:"thing"}}
requestHelper.post(def,obj)}
function saveTricks(def,data){db_Sync.saveTricks(def,data)}
function createNewTrick(def,data){db_Tricks.createNewTrick(def,data)}
function pushReorder(data){var serverAr=[];for(var i=0;i<data.length;i++){serverAr.push({'trick_id':data[i].id,'ordinal':data[i].ordinal})}
var def2=$.Deferred()
var promise=def2.promise();promise.then(function(data){localStorage.removeItem("trickReoderSync")},function(error){localStorage.setItem("trickReoderSync",!0)});kmodel_MyTricks.reorderTricks(def2,serverAr);db_Tricks.reorederTricks(data)}
function deleteTrick(def,data){db_Tricks.deleteTrick(def,data)}
function getTrickImage(def,data){var obj={"class":"trick","method":"getImageSmall","data":data}
requestHelper.post(def,obj)}
return{getTricks:getTricks,pushReorder:pushReorder,saveTricks:saveTricks,getTricksFromServer:getTricksFromServer,createNewTrick:createNewTrick,deleteTrick:deleteTrick,getTrickImage:getTrickImage}});App.factory("model_Dog",function($q,$http,requestHelper,$cordovaFile,model_DownloadFiles){var dogImagePromise=$q.defer().promise;var dogImageSaveInProgress=!1;function getDogName(){return localStorage.getItem('dogName')}
function deleteDogImage(){var previousPic=window.localStorage.getItem('dogImage');if(previousPic!=null&&previousPic!=''){var imageName=previousPic.substring(previousPic.lastIndexOf('/')+1,previousPic.length);$cordovaFile.removeFile(VAR_MOBILE_FOLDER+imageName)}
window.localStorage.removeItem('dogImage')}
function saveDogImage(url){dogImageSaveInProgress=!0;var defer=$q.defer();dogImagePromise=defer.promise;if(IS_SIMULATOR){defer.resolve(!0);return null}
var assetURL=url;var imageName=url.substring(url.lastIndexOf('/')+1,url.length);var fileName=VAR_MOBILE_FOLDER+imageName;var fileTransfer=new FileTransfer();store=cordova.file.dataDirectory;console.log("saving image in url----------------");console.log(store+'/'+fileName);console.log(assetURL);console.log(fileTransfer);fileTransfer.download(assetURL,store+'/'+fileName,function(entry){console.log(entry);console.log("successs saved image");var previousPic=window.localStorage.getItem('dogImage');if(previousPic!=null&&previousPic!=''){var imageNamePrev=previousPic.substring(previousPic.lastIndexOf('/')+1,previousPic.length);if(imageNamePrev!=imageName){$cordovaFile.removeFile(VAR_MOBILE_FOLDER+imageName)}}
window.localStorage.setItem('dogImage',entry.nativeURL);defer.resolve(entry.nativeURL);kmodel_UploadDogImage.resetImages()},function(err){console.log("failed saved");console.log("download error source "+error.source);console.log("download error target "+error.target);console.log("upload error code "+error.code);defer.reject(!1);dogImageSaveInProgress=!1})}
function getDogImage(){if(dogImageSaveInProgress){return dogImagePromise}else{var defer=$q.defer();defer.resolve(window.localStorage.getItem('dogImage'));return defer.promise}}
function saveTrainingOffline(){}
return{getDogName:getDogName,saveDogImage:saveDogImage,getDogImage:getDogImage,deleteDogImage:deleteDogImage}});App.factory("model_Share",function($q,$http,requestHelper,$rootScope,$location){function shareAchivment(def,id){data={id:id};var obj={"class":"achievment","method":"shareAchievment","data":data}
kendo_RequestHelper.post(def,obj)}
return{shareAchivment:shareAchivment,}});App.factory("model_Goal",function($q,$http,requestHelper,$cordovaFile){function updateGoal(def,data){var days=getImportantDays();data=$.extend(days,data);var obj={"class":"goal","method":"setGoal","data":data}
kendo_RequestHelper.post(def,obj)}
function setGoal(type,goal,data){if(type=='daily'){window.localStorage.setItem('dailyGoal',goal)}else if(type=='weekly'){window.localStorage.setItem('weeklyGoal',goal)}}
function getGoal(type){if(type=='daily'){return window.localStorage.getItem('dailyGoal')}else if(type=='weekly'){return window.localStorage.getItem('weeklyGoal')}
return null}
function getImportantDays(){var d=new Date();var today=kendo_DateHelper.formatDateForDb(d);var weeklyGoalDayStart=kendo_DateHelper.formatDateForDb(moment().startOf('week').toDate());var weeklyGoalDayEnd=kendo_DateHelper.formatDateForDb(moment().endOf('week').toDate());console.log("get important days.-----------");console.log(weeklyGoalDayStart);console.log(weeklyGoalDayEnd)
return{weeklyDayStart:weeklyGoalDayStart,weeklyDayEnd:weeklyGoalDayEnd,dailyToday:today,}}
function clearGoals(){window.localStorage.removeItem('dailyGoal');window.localStorage.removeItem('dailyGoalDone');window.localStorage.removeItem('dailyGoalDay');window.localStorage.removeItem('weeklyGoal');window.localStorage.removeItem('weeklyGoalDone');window.localStorage.removeItem('weeklyGoalDayStart');window.localStorage.removeItem('weeklyGoalDayEnd')}
function updateGoalsDataFromServer(data){if(data.dailyGoal){window.localStorage.setItem('dailyGoal',data.dailyGoal)}
window.localStorage.setItem('dailyGoalDone',data.dailyGoalDone);var d=new Date();var today=kendo_DateHelper.formatDateForDb(d);window.localStorage.setItem('dailyGoalDay',today);var newGoalDayStart=moment().startOf('week');var newGoalDayEnd=moment().endOf('week');if(data.weeklyGoal){window.localStorage.setItem('weeklyGoal',data.weeklyGoal)}
window.localStorage.setItem('weeklyGoalDone',data.weeklyGoalDone)
window.localStorage.setItem('weeklyGoalDayStart',newGoalDayStart);window.localStorage.setItem('weeklyGoalDayEnd',newGoalDayEnd)}
return{updateGoal:updateGoal,setGoal:setGoal,getGoal:getGoal,clearGoals:clearGoals,getImportantDays:getImportantDays,updateGoalsDataFromServer:updateGoalsDataFromServer}});App.factory("model_GoalDaily",function($q,$http,requestHelper,$cordovaFile,model_GoalWeekly,db_Trainig){var from=null;var to=null;function getGoalsDoneForMonth(def,data){db_Trainig.goalDailyForPeriod(def,data)}
function setFromTo(f,t){from=f;to=t}
function getFromTo(){return{from:from,to:to,}}
function clearFromTo(){from=null;to=null}
function getGoalProgress(def){var goal=window.localStorage.getItem('dailyGoal');if(goal){var def2=$q.defer();def2.promise.then(function(data){console.log("should resolve def1");def.resolve({goal:goal,goalDone:data})});var startOfDay=moment().startOf('day').unix();var endOfDay=moment().endOf('day').unix();var data={from:startOfDay,to:endOfDay};db_Trainig.getTotalDoneForPeriod(def2,data)}else{def.resolve(null)}}
return{getGoalProgress:getGoalProgress,getGoalsDoneForMonth:getGoalsDoneForMonth,setFromTo:setFromTo,getFromTo:getFromTo,clearFromTo:clearFromTo}});App.factory("model_GoalWeekly",function($q,$http,requestHelper,$cordovaFile,db_Trainig){var from=null;var to=null;function getGoalsDoneForMonth(def,data){db_Trainig.goalWeeklyForPeriod(def,data)}
function setFromTo(f,t){from=f;to=t}
function getFromTo(){return{from:from,to:to,}}
function clearFromTo(){from=null;to=null}
function getGoalProgress(def){var goal=window.localStorage.getItem('weeklyGoal');if(goal){var def2=$q.defer();def2.promise.then(function(data){console.log("should resolve def1");def.resolve({goal:goal,goalDone:data})});var startOfDay=moment().startOf('week').unix();var endOfDay=moment().endOf('week').unix();var data={from:startOfDay,to:endOfDay};db_Trainig.getTotalDoneForPeriod(def2,data)}else{def.resolve(null)}}
return{getGoalProgress:getGoalProgress,getGoalsDoneForMonth:getGoalsDoneForMonth,setFromTo:setFromTo,getFromTo:getFromTo,clearFromTo:clearFromTo}});App.factory("model_GoalDetails",function($q,$http,requestHelper,$cordovaFile,db_Trainig){var detailsData;function getTricksForPeriod(def,data){db_Trainig.getTricksDoneForPeriod(def,data)}
function setDetailsData(data){detailsData=data}
function getDetailsData(){return detailsData}
return{getTricksForPeriod:getTricksForPeriod,setDetailsData:setDetailsData,getDetailsData:getDetailsData}});App.factory("model_Level",function($q,$http,requestHelper){function updatePoints(data){var points=parseInt(window.localStorage.getItem('dogPointsNeededToLvlUp'))-(data.timesTrained-data.timesSuccess)-data.timesSuccess*2;window.localStorage.setItem('dogPointsNeededToLvlUp',points)}
function updateLevel(data){if(data.pointsNeeded){window.localStorage.setItem('dogTitle',data.title);window.localStorage.setItem('dogPointsNeededToLvlUp',data.pointsNeeded);window.localStorage.setItem('dogLevel',data.userLevel);window.localStorage.setItem('dogLevelWorthPoints',data.levelPoints)}}
function clearLevel(data){window.localStorage.removeItem('dogPointsNeededToLvlUp');window.localStorage.removeItem('dogLevel');window.localStorage.removeItem('dogLevelWorthPoints')}
function getLevelPoints(data){var lvl=parseInt(window.localStorage.getItem('dogLevel'));var pointsNeeded=parseInt(window.localStorage.getItem('dogPointsNeededToLvlUp'));var dogLevelWorthPoints=parseInt(window.localStorage.getItem('dogLevelWorthPoints'));var lvlPercentage=(dogLevelWorthPoints-pointsNeeded)/dogLevelWorthPoints;if(pointsNeeded==1){var pointsText="point"}else{var pointsText="points"}
if(lvl>=1000){var maxLevel=!0}
return{title:window.localStorage.getItem('dogTitle'),lvl:lvl,nextLvl:lvl+1,pointsNeeded:pointsNeeded,pointsText:pointsText,maxLevel:maxLevel,clearLevel:clearLevel,lvlPercentage:lvlPercentage}}
return{updatePoints:updatePoints,updateLevel:updateLevel,getLevelPoints:getLevelPoints,clearLevel:clearLevel}});App.factory("model_ServerSync",function($q,$http,requestHelper,$rootScope,$location,db_Sync){function isSyncNeeded(def){if(window.localStorage.getItem('serverSyncRequired')){return !0}else{return !1}}
function setSync(){var serverSync=window.localStorage.getItem('serverSyncRequired');if(!serverSync){window.localStorage.setItem("serverSyncRequired","true")}}
function updateSync(time,overwrite){window.localStorage.setItem("serverSyncRequired","true");if(overwrite){window.localStorage.setItem("serverSyncDate",time)}else{var prevTime=window.localStorage.getItem("serverSyncDate");if(parseInt(prevTime)<time){window.localStorage.setItem("serverSyncDate",time)}}}
function getSyncTime(){return window.localStorage.getItem("serverSyncDate")}
function clearSyncNeeded(){window.localStorage.removeItem("serverSyncRequired");window.localStorage.removeItem("serverSyncDate")}
function uploadTraining(def,data){var obj={"class":"training","method":"trainMultiple","data":{training:data}}
console.log(obj);requestHelper.post(def,obj)}
function getTotalTrainings(def){db_Sync.getTotalTrainings(def,getSyncTime())}
function getTraining(def,offset){db_Sync.getTraining(def,offset)}
function deleteUploadedTraining(def){db_Sync.deleteUploadedTraining(def)}
function getTotalTrainingsServer(def){var def2=$q.defer();def2.promise.then(function(data){data.bufferSize=db_Sync.getBufferSize();def.resolve(data)});var obj={"class":"training","method":"getTrainingCount","data":{some:'data'}}
requestHelper.post(def2,obj)}
function getTrainingsServer(def,data){var obj={"class":"training","method":"getTrainingForLocal","data":data}
requestHelper.post(def,obj)}
function saveTrainingsToDb(def,data){db_Sync.saveTraining(def,data)}
return{isSyncNeeded:isSyncNeeded,setSync:setSync,getSyncTime:getSyncTime,updateSync:updateSync,uploadTraining:uploadTraining,getTotalTrainings:getTotalTrainings,getTraining:getTraining,clearSyncNeeded:clearSyncNeeded,getTotalTrainingsServer:getTotalTrainingsServer,getTrainingsServer:getTrainingsServer,saveTrainingsToDb:saveTrainingsToDb,deleteUploadedTraining:deleteUploadedTraining}});App.factory("model_Clicker",function($q,$http,requestHelper,$cordovaFile,db_Sync,db_Tricks){function getCanelioBLEIds(){return{service:'C033',measurement:'C034'}}
function getS1(){return window.localStorage.getItem('s1')}
function getS2AndHour(){var s2=JSON.parse(window.localStorage.getItem("s2"));var times=getMinutesSecondsToFullHour();s2.push(times.m);s2.push(times.s);s2.push(0,0);return{s2:s2,time:times.time,}}
function getSyncTime(){return parseInt(window.localStorage.getItem('clickerSyncTime'))}
function resetSyncTime(){window.localStorage.setItem("clickerSyncTime",moment().startOf('hour').unix())}
function saveTraining(def,data){db_Sync.saveTrainingFromClicker(def,data)}
function getFirstFiveTricks(def,data){db_Tricks.getFirst5Ids(def)}
function getMinutesSecondsToFullHour(){return{m:parseInt(moment().format('m')),s:parseInt(moment().format('s')),time:moment().startOf('hour').unix(),}}
function connectS3(def,data){var obj={"class":"clicker","method":"getConnectVariables","data":data}
kendo_RequestHelper.post(def,obj)}
function claimClicker(def,data){var obj={"class":"clicker","method":"claimClicker","data":data}
kendo_RequestHelper.post(def,obj)}
function saveClicker(data){window.localStorage.setItem("s1",data.s1);window.localStorage.setItem("s2",JSON.stringify(data.s2));saveSyncTime(data.time)}
function saveSyncTime(data){window.localStorage.setItem("clickerSyncTime",data)}
function setSyncRequired(){window.localStorage.setItem("clickerSyncRequired","1")}
function clearSyncRequired(){window.localStorage.removeItem("clickerSyncRequired")}
function getSyncRequired(){return window.localStorage.getItem("clickerSyncRequired")}
function disconnectClicker(def,data){var def2=$q.defer();def2.promise.then(function(success){console.log("dc success");window.localStorage.removeItem('clickerSyncTime');window.localStorage.removeItem('clickerSyncRequired');window.localStorage.removeItem('s1');window.localStorage.removeItem('s2');window.localStorage.removeItem("clickerDontSyncOnStart");def.resolve(!0)},function(error){window.localStorage.removeItem('clickerSyncTime');window.localStorage.removeItem('clickerSyncRequired');window.localStorage.removeItem('s1');window.localStorage.removeItem('s2');window.localStorage.removeItem("clickerDontSyncOnStart");def.resolve(!0);0});var obj={"class":"clicker","method":"disconnectClicker","data":{s1:getS1(),s2:JSON.parse(window.localStorage.getItem("s2"))}}
console.log("dcing");console.log(obj.data.s2);kendo_RequestHelper.post(def2,obj)}
return{getCanelioBLEIds:getCanelioBLEIds,getSyncTime:getSyncTime,resetSyncTime:resetSyncTime,getMinutesSecondsToFullHour:getMinutesSecondsToFullHour,getFirstFiveTricks:getFirstFiveTricks,saveTraining:saveTraining,getS1:getS1,getS2AndHour:getS2AndHour,connectS3:connectS3,claimClicker:claimClicker,saveSyncTime:saveSyncTime,saveClicker:saveClicker,setSyncRequired:setSyncRequired,clearSyncRequired:clearSyncRequired,getSyncRequired:getSyncRequired,disconnectClicker:disconnectClicker,}});App.factory("model_ResultUpload",function($q,$http,requestHelper,model_Level,stringHelper){var result={fromResultUpload:!0,step:1,showSucessRates:!0,titleWon:!1,lvlsWon:0,achivmentsTotal:0,lvl:65,title:'authorty challanger',achivementsWon:[{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'},{img:'res/logo062244White.png',trick:'Sit'}],tricks:[{trick:'Sit',success:'256',total:'300'},{trick:'Stay',success:'50',total:'300'},{trick:'Lay',success:'200',total:'300'},{trick:'Fetch',success:'90',total:'300'},{trick:'Clicker training',success:'270',total:'300'},]};function getResult(){return result}
function setResult(data){result={};result.showSucessRates=data.showSucessRates;result.achivementsWon=[];result.tricks=[];result.achivmentsTotal=0;result.lvlsWon=0;if(data.level.length>0){var prevLvlData=model_Level.getLevelPoints();console.log(data.level);model_Level.updateLevel(data.level[data.level.length-1]);var newLvlData=model_Level.getLevelPoints();result.lvlsWon=newLvlData.lvl-prevLvlData.lvl;result.title=newLvlData.title;result.lvl=newLvlData.lvl;if(prevLvlData.title!=newLvlData.title){result.titleWon=!0}}
if(data.tricks.length>0){var tricks=[];for(var i=0;data.tricks.length>i;i++){console.log("pushing tricks");tricks.push(data.tricks[i]);console.log(tricks);console.log(tricks[i]);tricks[i].trick=tricks[i].name;tricks[i].trick=stringHelper.formatWith3Dots(tricks[i].trick,18,320,320);console.log(tricks[i].total);if(tricks[i].total==0){console.log("here it is-.....");tricks[i].noResults=!0}}
console.log("##################################");console.log(tricks);result.tricks=tricks}
console.log(data);if(data.achivments.length>0){result.achivmentsTotal=data.achivments.length;var achivmentsWon=[];for(var i=0;i<data.achivments.length;i++){var a={img:'res/logo062244White.png',trick:data.achivments[i].trickName,achivmentId:data.achivments[i].achivmentId,trickId:data.achivments[i].trickId};achivmentsWon.push(a)}
result.achivementsWon=achivmentsWon}
result.fromResultUpload=!0,result.step=0;console.log(result)}
function saveDogImage(small,config){if(small!=null){for(var i=0;result.achivementsWon.length>i;i++){if(result.achivementsWon[i].trickId==config.trickId){result.achivementsWon[i].img=small;result.achivementsWon[i].hasImg=!0}}}}
function isFromResultUpload(){return result.fromResultUpload}
function clearFromResultUpload(){result.fromResultUpload=!1;result.step=1}
function setStep(step){result.step=step}
return{getResult:getResult,setResult:setResult,saveDogImage:saveDogImage,isFromResultUpload:isFromResultUpload,clearFromResultUpload:clearFromResultUpload,setStep:setStep}});App.factory("db_Trainig",function($q,$http,requestHelper,$cordovaFile){function trickStatisticsData(def,data){var from=moment(data.from).startOf('day').unix();var to=moment(data.to).endOf('day').unix();canelio_db.transaction(function(tx){tx.executeSql("SELECT SUM(timesSuccess) as success,SUM(timesTrained) as total,strftime('%Y-%m-%d',"+'time'+",'unixepoch') AS 'date' FROM training"+" WHERE trick_id = ? AND time >= ? AND time <= ? GROUP BY strftime('%Y-%m-%d',"+'time'+",'unixepoch')  order by time desc",[data.trick_id,from,to],function(tx,res){var returned;if(res.rows.length==0){returned=[]}else{var ar=[];for(var i=0;res.rows.length>i;i++){ar.push(res.rows.item(i))}
returned=ar}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function insertTraining(data){var time=moment(data.dateTimeTrained);canelio_db.transaction(function(tx){tx.executeSql("SELECT COUNT(*) as cnt, SUM(timesSuccess) as success,SUM(timesTrained) as total from training where time = ? AND  trick_id= ? ",[time.unix(),data.trick_id,],function(tx,res){if(res.rows.item(0).cnt==0){tx.executeSql("INSERT INTO training (time, trick_id,timesSuccess,timesTrained) VALUES (?,?,?,?)",[time.unix(),data.trick_id,data.timesSuccess,data.timesTrained],function(tx,res){},function(){console.log("insert fail")})}else{var total=res.rows.item(0).total+data.timesTrained;var success=data.timesSuccess+res.rows.item(0).success;tx.executeSql("UPDATE training  SET  timesSuccess = ?,timesTrained = ? WHERE time = ? AND trick_id = ?",[success,total,time.unix(),data.trick_id],function(tx,res){console.log("insert success")})}})})}
function todayTrickStatistics(def,data){var from=moment(data.dateTime).startOf('day').unix();var to=moment(data.dateTime).endOf('day').unix();canelio_db.readTransaction(function(tx){tx.executeSql("SELECT  COUNT(*) as cnt,SUM(timesTrained) as timesTrained,SUM(timesSuccess) as timesSuccess FROM training"+" WHERE trick_id = ? AND time >= ? AND time <= ?",[data.trick_id,from,to],function(tx,res){var returned;if(res.rows.item(0).cnt==0){returned=[]}else{returned=res.rows.item(0)}
console.log("returning");console.log(returned);def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function goalDailyForPeriod(def,data){var from=moment(data.from);var to=moment(data.to);var fromUnix=moment(data.from).startOf('day').unix();var toUnix=moment(data.to).endOf('day').unix();var goal=data.goal;canelio_db.transaction(function(tx){tx.executeSql("SELECT SUM(timesTrained) as total,strftime('%Y-%m-%d',"+'time'+",'unixepoch') AS 'date' FROM training"+" WHERE time >= ? AND time <= ? GROUP BY strftime('%Y-%m-%d',"+'time'+",'unixepoch')  order by time desc",[fromUnix,toUnix],function(tx,res){var returned;var ar=[];for(var i=0;res.rows.length>i;i++){ar.push(res.rows.item(i))}
returned=ar;var endReached=!1;var resultsPointer=returned.length-1;var fromDate=to.format('YYYY-MM-DD');var currentDate=moment(data.from);var dates=[];while(!endReached){var currentDateFormatted=currentDate.format('YYYY-MM-DD');currentDate=currentDate.endOf('day');if(resultsPointer!=-1&&returned[resultsPointer].date==currentDateFormatted){returned[resultsPointer].day=currentDate.format('D');if(goal<=returned[resultsPointer].total){returned[resultsPointer].goalAchieved=!0}else{returned[resultsPointer].goalAchieved=!1}
dates.push(returned[resultsPointer]);resultsPointer--}else{var date={date:currentDateFormatted,day:currentDate.format('D'),goalAchieved:!1,nan:!0,}
dates.push(date)}
if(fromDate==currentDateFormatted){endReached=!0}
currentDate=currentDate.add('1','s')}
def.resolve(dates)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function goalWeeklyForPeriod(def,data){var goal=data.goal;var weeks=data.weeks;var sqlsTotal=weeks.length;function getOneWeek(week,i){var fromUnix=moment(data.weeks[i].from).startOf('day').unix();var toUnix=moment(data.weeks[i].to).endOf('day').unix();canelio_db.transaction(function(tx){tx.executeSql("SELECT SUM(timesTrained) as total, count(*) as cnt FROM training"+" WHERE time >= ? AND time <= ?  ",[fromUnix,toUnix],function(tx,res){var result=res.rows.item(0);weeks[i].trained=result.total;if(result.total>=goal){weeks[i].goalAchieved=!0}else{weeks[i].goalAchieved=!1}
i++;if(sqlsTotal==i){def.resolve(weeks)}else{getOneWeek(weeks[i],i)}},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
getOneWeek(weeks[0],0)}
function getTricksDoneForPeriod(def,data){var fromUnix=moment(data.from).startOf('day').unix();var toUnix=moment(data.to).endOf('day').unix();canelio_db.transaction(function(tx){tx.executeSql("SELECT trick_id as trickId,SUM(training.timesTrained) as timesTrained,SUM(timesSuccess) as timesSuccess , tricks.name as trickName FROM training JOIN tricks ON tricks.id = training.trick_id "+" WHERE training.time >= ? AND training.time <= ?  GROUP BY training.trick_id ",[fromUnix,toUnix],function(tx,res){var returned;if(res.rows.length==0){returned=[]}else{var ar=[];for(var i=0;res.rows.length>i;i++){ar.push(res.rows.item(i))}
returned=ar}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function getTotalDoneForPeriod(def,data){canelio_db.transaction(function(tx){tx.executeSql("SELECT SUM(timesTrained) as timesTrained  FROM training WHERE time >= ? AND time <= ? ",[data.from,data.to],function(tx,res){var returned;if(res.rows.length==0){returned=0}else{returned=res.rows.item(0).timesTrained}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function getTrickTotal(def,data){canelio_db.transaction(function(tx){tx.executeSql("SELECT SUM(timesTrained) as timesTrained,SUM(timesSuccess) as timesSuccess   FROM training WHERE trick_id = ? ",[data.trickId],function(tx,res){var returned;if(res.rows.length==0){returned={timesTrained:0,timesSuccess:0,}}else{returned=res.rows.item(0)}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
return{trickStatisticsData:trickStatisticsData,getTrickTotal:getTrickTotal,insertTraining:insertTraining,todayTrickStatistics:todayTrickStatistics,goalDailyForPeriod:goalDailyForPeriod,goalWeeklyForPeriod:goalWeeklyForPeriod,getTricksDoneForPeriod:getTricksDoneForPeriod,getTotalDoneForPeriod:getTotalDoneForPeriod}});App.factory("db_Manager",function($q,$http,requestHelper,$cordovaFile){function createTables(def){canelio_db.transaction(function(tx){tx.executeSql('DROP TABLE IF EXISTS training');tx.executeSql('CREATE TABLE IF NOT EXISTS training (time integer, trick_id integer, timesSuccess integer, timesTrained integer)');tx.executeSql('DROP TABLE IF EXISTS tricks');tx.executeSql('CREATE TABLE IF NOT EXISTS tricks (id integer, name text , ordinal integer)');tx.executeSql('DROP TABLE IF EXISTS trainingForUpload');tx.executeSql('CREATE TABLE IF NOT EXISTS trainingForUpload (time integer, trick_id integer, timesSuccess integer, timesTrained integer)');def.resolve(!0)})}
function dropTable(def,data){canelio_db.transaction(function(tx){alertify.success("success");tx.executeSql('DROP TABLE IF EXISTS training')})}
return{createTables:createTables}});App.factory("db_Sync",function($q,$http,requestHelper,$cordovaFile,db_TrainingForServer){var bufferRowsOfData=500;function getTotalTrainings(def){db_TrainingForServer.getTotalTrainings(def,bufferRowsOfData)}
function getTraining(def,offset){db_TrainingForServer.getTraining(def,offset,bufferRowsOfData)}
function deleteUploadedTraining(def){db_TrainingForServer.deleteRows(def,bufferRowsOfData)}
function getBufferSize(){return bufferRowsOfData}
function saveTraining(def,data){var executed=0;canelio_db.transaction(function(tx){for(var i=0;i<data.length;i++){tx.executeSql("INSERT INTO training (time, trick_id,timesSuccess,timesTrained) VALUES (?,?,?,?)",[data[i].time,data[i].trick_id,data[i].timesSuccess,data[i].timesTrained],function(tx,res){executed++;if(executed==data.length){def.resolve(!0)}},function(e){console.log("ERROR: "+e.message)})}});if(data.length==0){def.resolve(!0)}}
function saveTrainingFromClicker(def,data){console.log("data length is");console.log(data.length);console.log(data);if(data.length==0){def.resolve(!0)}else{console.log("in else");var executed=0;var checkForUpdateTimeNeeded=!1;var defExecuted=$q.defer();defExecuted.promise.then(function(data){def.resolve(!0)},function(error){},function(update){executed++;if(executed==data.length){defExecuted.resolve(!0)}});canelio_db.transaction(function(tx){function saveOrUpdateTraining(def,data,notify){tx.executeSql("SELECT COUNT(*) as cnt, timesSuccess,timesTrained FROM training WHERE time=? AND trick_id =?",[data.time,data.trick_id],function(tx,res){var row=res.rows.item(0);if(row.cnt!=0){tx.executeSql("UPDATE training SET timesSuccess=? , timesTrained =? WHERE time=? AND trick_id =?",[data.timesSuccess+row.timesSuccess,data.timesTrained+row.timesTrained,data.time,data.trick_id],function(tx,res){if(notify){def.notify(!0)}else{def.resolve(!0)}},function(e){console.log("ERROR: "+e.message)})}else{tx.executeSql("INSERT INTO training (time, trick_id,timesSuccess,timesTrained) VALUES (?,?,?,?)",[data.time,data.trick_id,data.timesSuccess,data.timesTrained],function(tx,res){if(notify){def.notify(!0)}else{def.resolve(!0)}},function(e){console.log("ERROR: "+e.message)})}},function(e){console.log("ERROR: "+e.message)})}
for(var i=0;i<data.length;i++){saveOrUpdateTraining(defExecuted,data[i],!0)}})}}
function saveTricks(def,data){var inserted=0;canelio_db.transaction(function(tx){for(var i=0;i<data.length;i++){tx.executeSql("INSERT INTO tricks (id, name,ordinal) VALUES (?,?,?)",[data[i].id,data[i].name,data[i].ordinal],function(tx,res){inserted++;if(inserted==data.length){def.resolve(!0)}},function(e){})}})}
return{getTotalTrainings:getTotalTrainings,getTraining:getTraining,getBufferSize:getBufferSize,saveTraining:saveTraining,saveTricks:saveTricks,saveTrainingFromClicker:saveTrainingFromClicker,deleteUploadedTraining:deleteUploadedTraining,}});App.factory("db_Tricks",function($q,$http,requestHelper,$cordovaFile){function getTricks(def,data){canelio_db.transaction(function(tx){tx.executeSql("SELECT id,name,ordinal FROM tricks ORDER BY ordinal asc",[],function(tx,res){var returned;if(res.rows.length==0){returned=[]}else{var ar=[];for(var i=0;res.rows.length>i;i++){ar.push(res.rows.item(i))}
returned=ar}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function getFirst5Ids(def,data){canelio_db.transaction(function(tx){tx.executeSql("SELECT id,name FROM tricks ORDER BY ordinal asc LIMIT 5 OFFSET 0",[],function(tx,res){var returned;if(res.rows.length==0){returned=[]}else{var ar=[];for(var i=0;res.rows.length>i;i++){ar.push(res.rows.item(i))}
returned=ar}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function reorederTricks(data){canelio_db.transaction(function(tx){for(var i=0;i<data.length;i++){tx.executeSql("UPDATE tricks SET ordinal =? WHERE id =?",[data[i].ordinal,data[i].id],function(tx,res){},function(e){})}})}
function createNewTrick(def,data){canelio_db.transaction(function(tx){console.log("tricks are...................");console.log(data);tx.executeSql("UPDATE tricks SET ordinal =ordinal+1 WHERE ordinal > 5",[],function(tx,res){tx.executeSql("INSERT INTO tricks (id, name,ordinal) VALUES (?,?,?)",[data.id,data.name,6],function(tx,res){def.resolve(!0)},function(e){})},function(e){})})}
function deleteTrick(def,data){canelio_db.transaction(function(tx){console.log("tricks are...................");console.log(data);tx.executeSql("DELETE FROM tricks WHERE id = ?",[data],function(tx,res){def.resolve(!0)},function(e){})})}
return{getTricks:getTricks,reorederTricks:reorederTricks,createNewTrick:createNewTrick,deleteTrick:deleteTrick,getFirst5Ids:getFirst5Ids}});App.factory("db_TrainingForServer",function($q,$http,requestHelper,$cordovaFile){function insertTraining(def,data){if(data.length==0){def.resolve(!0)}
var executed=0;canelio_db.transaction(function(tx){for(var i=0;i<data.length;i++){tx.executeSql("INSERT INTO trainingForUpload (time, trick_id,timesSuccess,timesTrained) VALUES (?,?,?,?)",[data[i].time,data[i].trick_id,data[i].timesSuccess,data[i].timesTrained],function(tx,res){executed++;if(executed==data.length){def.resolve(!0)}},function(){console.log("insert fail")})}})}
function insertTrainingSingleRep(def,data){if(data.length==0){def.resolve(!0)}else{var executed=0;var checkForUpdateTimeNeeded=!1;var defExecuted=$q.defer();defExecuted.promise.then(function(data){def.resolve(!0)},function(error){},function(update){executed++;if(executed==data.length){defExecuted.resolve(!0)}});canelio_db.transaction(function(tx){function saveOrUpdateTraining(def,data,notify){tx.executeSql("SELECT COUNT(*) as cnt, timesSuccess,timesTrained FROM trainingForUpload WHERE time=? AND trick_id =?",[data.time,data.trick_id],function(tx,res){var row=res.rows.item(0);if(row.cnt!=0){tx.executeSql("UPDATE trainingForUpload SET timesSuccess=? , timesTrained =? WHERE time=? AND trick_id =?",[data.timesSuccess+row.timesSuccess,data.timesTrained+row.timesTrained,data.time,data.trick_id],function(tx,res){if(notify){def.notify(!0)}else{def.resolve(!0)}},function(e){console.log("ERROR: "+e.message)})}else{tx.executeSql("INSERT INTO trainingForUpload (time, trick_id,timesSuccess,timesTrained) VALUES (?,?,?,?)",[data.time,data.trick_id,data.timesTrained,data.timesSuccess],function(tx,res){if(notify){def.notify(!0)}else{def.resolve(!0)}},function(e){console.log("ERROR: "+e.message)})}},function(e){console.log("ERROR: "+e.message)})}
for(var i=0;i<data.length;i++){saveOrUpdateTraining(defExecuted,data[i],!0)}})}}
function getTotalTrainings(def,bufferRowsOfData){canelio_db.transaction(function(tx){tx.executeSql("SELECT COUNT(*) as cnt FROM trainingForUpload",[],function(tx,res){def.resolve({totalRows:res.rows.item(0).cnt,bufferSize:bufferRowsOfData})},function(e){console.log("get total training failed");console.log(e);console.log("ERROR: "+e.message)})})}
function getTraining(def,offset,bufferRowsOfData){canelio_db.transaction(function(tx){tx.executeSql("SELECT * FROM trainingForUpload ORDER BY ROWID ASC LIMIT ? OFFSET ? ",[bufferRowsOfData,offset],function(tx,res){var returned=[];for(var i=0;res.rows.length>i;i++){returned.push(res.rows.item(i))}
def.resolve(returned)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
function deleteRows(def,bufferSize){canelio_db.transaction(function(tx){tx.executeSql("DELETE FROM trainingForUpload WHERE ROWID IN (SELECT ROWID FROM trainingForUpload ORDER BY ROWID ASC LIMIT ?) ",[bufferSize],function(tx,res){def.resolve(!0)},function(e){console.log(e);console.log("ERROR: "+e.message)})})}
return{insertTraining:insertTraining,insertTrainingSingleRep:insertTrainingSingleRep,getTotalTrainings:getTotalTrainings,getTraining:getTraining,deleteRows:deleteRows}});App.directive('mainNav',function($rootScope){return{restrict:"E",templateUrl:'directives/mainNav/mainNav.html',link:function($scope,$element,$attrs){if(typeof $scope.navigateBack!=="function"){$scope.navigateBack=function(){if(typeof $scope.navigateBackBefore==="function"){$scope.navigateBackBefore()}
$rootScope.goBack()}}
if(typeof $scope.mainNav_datePicker_click!=="function"){$scope.mainNav_datePicker_click=function(){}}
if($attrs.datepicker=="true"){$scope.mainNav_datePicker_show=!0}
if(typeof $scope.mainNav_settings_click!=="function"){console.log("overwriting mainav settings click");$scope.mainNav_settings_click=function(){}}
if($attrs.settings=="true"){$scope.mainNav_settings_show=!0}
if(typeof $scope.mainNav_history_click!=="function"){$scope.mainNav_history_click=function(){}}
if($attrs.history=="true"){$scope.mainNav_history_show=!0}
if(typeof $scope.mainNav_delete_click!=="function"){$scope.mainNav_delete_click=function(){}}
if($attrs.delete=="true"){$scope.mainNav_delete_show=!0}
if(typeof $scope.mainNav_statistic_click!=="function"){$scope.mainNav_statistic_click=function(){}}
if($attrs.statistic=="true"){$scope.mainNav_statistic_show=!0}}}});App.directive('datesPicker',function(dateHelper,$parse){return{restrict:"C",templateUrl:'directives/datesPicker/datesPicker.html',link:function($scope,$element,$attrs){if(typeof $scope.datesChanged!=="function"){$scope.datesChanged=function(){}}
$scope.datesPicker_toPickerFocused=function(){$('#toPicker').data('kendoDatePicker').open()}
$scope.datesPicker_fromPickerFocused=function(id){$('#fromPicker').data('kendoDatePicker').open()}
$scope.lastDaysClicked=function(days){var from=dateHelper.getDateMinusDays(days,!0);var to=dateHelper.getCurrentDate(!0);$scope.datesPicker_fromObject=from;$scope.datesPicker_toObject=to;from=dateHelper.formatDateForDb(from);to=dateHelper.formatDateForDb(to);$scope.datesPicker_pick=days;$scope.datesChanged(from,to);$scope.showDatesPicker=!1}
$scope.datesPicker_costumeDatesClicked=function(){if($scope.datesPicker_fromObject>$scope.datesPicker_toObject){alertify.error("From date must be before To date");$scope.datesPicker_fromObject=$scope.datesPicker_toObject;$('#fromPickerContainer').addClass('datesError');setTimeout(function(){$('#fromPickerContainer').removeClass('datesError')},3000);return null}
$scope.datesPicker_pick='custome';console.log("custome");console.log($scope.datesPicker_fromObject)
$scope.datesChanged(dateHelper.formatDateForDb($scope.datesPicker_fromObject),dateHelper.formatDateForDb($scope.datesPicker_toObject));$scope.showDatesPicker=!1}
$scope.datesPicker_isSelected=function(pick){if($scope.datesPicker_pick==pick){return !0}
return !1}
$scope.lastDaysClicked(9999)}}});App.directive('weightDatesPicker',function(dateHelper,$parse){return{restrict:"C",templateUrl:'directives/weightDatesPicker/weightDatesPicker.html',link:function($scope,$element,$attrs){if(typeof $scope.datesChanged!=="function"){$scope.datesChanged=function(){}}
$scope.datesPicker_toPickerFocused=function(){$('#toPicker').data('kendoDatePicker').open()}
$scope.datesPicker_fromPickerFocused=function(id){$('#fromPicker').data('kendoDatePicker').open()}
$scope.lastDaysClicked=function(days){var from=dateHelper.getDateMinusDays(days,!0);var to=dateHelper.getCurrentDate(!0);$scope.datesPicker_fromObject=from;$scope.datesPicker_toObject=to;from=dateHelper.formatDateForDb(from);to=dateHelper.formatDateForDb(to);$scope.datesPicker_pick=days;$scope.datesChanged(from,to);$scope.showDatesPicker=!1}
$scope.datesPicker_costumeDatesClicked=function(){if($scope.datesPicker_fromObject>$scope.datesPicker_toObject){alertify.error("From date must be before To date");$scope.datesPicker_fromObject=$scope.datesPicker_toObject;$('#fromPickerContainer').addClass('datesError');setTimeout(function(){$('#fromPickerContainer').removeClass('datesError')},3000);return null}
$scope.datesPicker_pick='custome';console.log("custome");console.log($scope.datesPicker_fromObject)
$scope.datesChanged(dateHelper.formatDateForDb($scope.datesPicker_fromObject),dateHelper.formatDateForDb($scope.datesPicker_toObject));$scope.showDatesPicker=!1}
$scope.datesPicker_isSelected=function(pick){if($scope.datesPicker_pick==pick){return !0}
return !1}
$scope.lastDaysClicked(9999)}}});App.directive('valuePicker',function(){return{restrict:"A",transclude:!0,link:function($scope,$element,$attrs){function xpos(e){if(e.originalEvent.targetTouches&&(e.originalEvent.targetTouches.length>=1)){return e.originalEvent.targetTouches[0].clientX}else if(e.originalEvent.touch){return e.originalEvent.touch.clientX}
return e.clientX}
var callbackOnChange=$scope[$attrs.onvaluechange];if(typeof callbackOnChange==="undefined"){callbackOnChange=function(){}}
var ValuePicker={_list:"",_tapped:!1,_overlay:"",minimumValue:0,maximumValue:100,max:0,min:0,offset:0,reference:0,pressed:!1,xform:"transform",velocity:0,frame:0,timestamp:0,ticker:null,amplitude:0,target:0,timeConstant:225,snap:0,adding:!1,init:function(element,options){var that=this;if(typeof $attrs.min!=="undefined"){that.minimumValue=parseInt($attrs.min)}
if(typeof $attrs.max!=="undefined"){that.maximumValue=parseInt($attrs.max)}
that._list=$('<ul class="madbarz-value-picker-list"></ul>');that._overlay=$('<div class="madbarz-value-picker-overlay"></div>');var container=$('<div class="madbarz-value-list-container"></div>');container.append(that._list);for(var i=that.minimumValue;i<=that.maximumValue;i++){$(that._list).append($('<li>'+i+'</li>'))}
$($(that._list).children()).on('click, touchend',function(e){setTimeout(function(){if(that._tapped){that.animatedGoTo(parseInt($(e.currentTarget).html()))}},100)});$(element).addClass('madbarz-value-picker');$(element).append(that._overlay);$(element).append(container);if(typeof window.ontouchstart!=='undefined'){$(element).on('touchstart',that.tap);$(element).on('touchmove',that.drag);$(element).on('touchend touchleave touchcancel',that.release)}
that.initNumbers();['webkit','Moz','O','ms'].every(function(prefix){var e=prefix+'Transform';if(typeof element.style[e]!=='undefined'){that.xform=e;return !1}
return !0})},initNumbers:function(){var that=this;var dr_svi=$(that._list).children();var dr_ukupno=$(dr_svi).length;var dr_prvi=$(that._list).children()[0];var dr_prvi_sirina=dr_prvi.getBoundingClientRect().width;that.max=dr_ukupno*dr_prvi_sirina;that.offset=0;$(that._overlay).width(dr_prvi_sirina);$(that._overlay).css('left',(dr_prvi_sirina*2)+"px");that.snap=(dr_prvi_sirina);that.min=-(that.snap*2);that.max=(dr_ukupno-3)*that.snap},scroll:function(x){var that=this;if(x>that.max){that.offset=that.max}else if(x<that.min){that.offset=that.min}else{that.offset=x}
that._list.css('transform','translate3d(0,0,0) translateX('+(-that.offset)+'px)');var maxSteps=Math.round(that.max/that.snap);var currentStep=Math.round(that.offset/that.snap);if(maxSteps-currentStep<10&&that.adding===!1){that.adding=!0;$($(that._list).children()).unbind("click");$($(that._list).children()).unbind("touchend");$($(that._list).children()).on('click, touchend',function(e){setTimeout(function(){if(that._tapped){that.animatedGoTo(parseInt($(e.currentTarget).html()))}},100)});that.max=($($(that._list).children()).length-3)*that.snap;that.adding=!1}},working:!1,tap:function(e){var that=ValuePicker;that._tapped=!0;that.working=!0;that.pressed=!0;that.reference=xpos(e);that.velocity=that.amplitude=0;that.frame=that.offset;that.timestamp=Date.now();clearInterval(that.ticker);function track(){var now,elapsed,delta,v;now=Date.now();elapsed=now-that.timestamp;timestamp=now;delta=that.offset-that.frame;that.frame=that.offset;v=1000*delta/(1+elapsed);that.velocity=0.8*v+0.2*that.velocity}
that.ticker=setInterval(track,100);e.preventDefault();e.stopPropagation();return !1},drag:function(e){var x,delta;var that=ValuePicker;that._tapped=!1;if(that.pressed){x=xpos(e);delta=that.reference-x;if(delta>2||delta<-2){that.reference=x;that.scroll(that.offset+delta)}}
e.preventDefault();e.stopPropagation();return !1},release:function(e){var that=ValuePicker;that.pressed=!1;function autoScroll(){var elapsed,delta;if(that.amplitude){elapsed=Date.now()-that.timestamp;delta=-that.amplitude*Math.exp(-elapsed/that.timeConstant);if(delta>5||delta<-5){that.scroll(that.target+delta);requestAnimationFrame(autoScroll)}else{that.scroll(that.target);var vl=Math.floor(that.target/that.snap)+2+that.minimumValue;if(vl<that.minimumValue)
vl=that.minimumValue;if(vl>that.maximumValue)
vl=that.maximumValue;that._update(vl)}
that.working=!1}}
clearInterval(that.ticker);that.target=that.offset;if(that.velocity>10||that.velocity<-10){that.amplitude=0.8*that.velocity;that.target=that.offset+that.amplitude}
that.target=Math.round(that.target/that.snap)*that.snap;that.amplitude=that.target-that.offset;that.timestamp=Date.now();requestAnimationFrame(autoScroll);e.preventDefault();e.stopPropagation();return !1},_value:1,value:function(v){var that=this;if(v===undefined)
return that._value;else{that._update(v);that._moveValue()}},animatedGoTo:function(v){var that=this;that._update(v);that._animatedMoveValue()},_update:function(value){var that=this;that._value=value;callbackOnChange(parseInt(that._value))},_animatedMoveValue:function(){var that=this;$(that._list).css('transition','all linear 0.3s');setTimeout(function(){that.scroll((that.value()-that.minimumValue-2)*that.snap)},50);setTimeout(function(){$(that._list).css('transition','')},360)},_moveValue:function(){var that=this;that.scroll((that.value()-2)*that.snap)},_change:function(value){var that=this;if(that._old!==value){that._update(value);that._old=value;that._value=value;callbackOnChange(parseInt(that._value)+that.minimumValue)}},getClosest:function(){that=this;var containerScrollLeft=that.offset;var containerWidth=$($element).width();var containerDistance=containerScrollLeft+containerWidth/2;var closestDistance=500;var closestElement=$($element).children(".madbarz-value-picker-list li:first");$($element).find(".madbarz-value-picker-list li").each(function(index){var elementPosition=$(this).offset().left;var elementWidth=$(this).width();var elementCenter=elementPosition+elementWidth/2;var elementDistance=Math.abs((containerWidth)/2-elementCenter);if(elementDistance<closestDistance){closestDistance=elementDistance;closestElement=$(this)}});return parseInt(closestElement.html())}};var scopeVariable=$attrs.variable;if(typeof scopeVariable!=="undefined"){$scope[scopeVariable]=ValuePicker}
ValuePicker.init($element[0])}}});App.directive('trainSettings',function(dateHelper,$parse){return{restrict:"C",templateUrl:'directives/trainSettings/trainSettings.html',link:function($scope,$element,$attrs){if(typeof $scope.trainTypeChanged!=="function"){$scope.trainTypeChanged=function(){}}
$scope.trainSettings_isSelected=function(type){if(type==$scope.trainingType)
return !0;else return !1}}}});App.directive('decimalInput',function($rootScope,$interval){return{restrict:"E",templateUrl:'directives/decimalInput/decimalInput.html',link:function($scope,$element,$attrs){if(typeof $scope.navigateBack!=="function"){$scope.navigateBack=function(){$rootScope.goBack()}}
$('.decimalInputContainer .input').html($scope.decimalInput_DefaultValue);$scope.decimalInput_addNumber=function(el){var add=$(el).children('.number').text();var before=$('.decimalInputContainer .input').append(add)}
$scope.decimalInput_deleteSign=function(){var text=$('.decimalInputContainer .input').text();text=text.substring(0,text.length-1);$('.decimalInputContainer .input').text(text)}
$('.decimalInputContainer .numberContainer').on('touchstart',function(e){$scope.decimalInput_addNumber(this);$(this).addClass('numberContainerActive')});$('.decimalInputContainer .numberContainer').on('touchend',function(e){$(this).removeClass('numberContainerActive')});$('.decimalInputContainer .numberContainer').on('mouseleave',function(e){$(this).removeClass('numberContainerActive')});$('.decimalInputContainer .deleteContainer').on('touchstart',function(e){$scope.decimalInput_deleteSign();$scope.decimalInput_deleteMouseDown()});$('.decimalInputContainer .deleteContainer').on('touchend',function(e){$scope.decimalInput_deleteMouseUp()});$('.decimalInputContainer .deleteContainer').on('mouseleave',function(e){$scope.decimalInput_deleteMouseUp()});$scope.decimalInput_reset=function(){$scope.decimalInput_visible=!$scope.decimalInput_visible;$('.decimalInputContainer .input').text('')}
$scope.decimalInput_delete=function(){if($scope.decimalInput_input.length!=0){$scope.decimalInput_input=$scope.decimalInput_input.substring(0,$scope.decimalInput_input.length-1)}}
$scope.decimalInput_deleteMouseDown=function(){$interval.cancel($scope.decimalInput_deleteInterval);$scope.decimalInput_deleteInterval=$interval(function(){$('.decimalInputContainer .input').text('')},500)}
$scope.decimalInput_deleteMouseUp=function(){$interval.cancel($scope.decimalInput_deleteInterval)}
var width=$('body').width();var edgeNumWidth=Math.floor((width-2)/3);var midNumWidth=((width-2)%3)+edgeNumWidth;$scope.decimalInput_getNumStyle=function(position){var width=edgeNumWidth;if(position=='mid'){width=midNumWidth}
return{width:width}}
$scope.decimalInput_inputFiledStyle=function(){var right=edgeNumWidth+6;return{right:right}}
$scope.decimalInput_saveStyle=function(){var left=edgeNumWidth+midNumWidth+6;return{left:left}}}}});function d3AreaChart(config){var $scope={};var totalHeight=300;if(config.height){totalHeight=config.height}
var margin={top:20,right:0,bottom:80,left:0},width=$('body').width()-margin.right-margin.left,height=totalHeight-margin.top-margin.bottom,numberOfYTicks=4;var animationLength=1000;var parseDate=d3.time.format("%d-%b-%y").parse;var xScale=d3.scale.linear();var x=xScale.range([0,width]);var yScale=d3.scale.linear();yScale.ticks(numberOfYTicks);var y=yScale.range([height,0]);var xAxis=d3.svg.axis().scale(x).orient("bottom");var yAxis=d3.svg.axis().scale(y).orient("left").ticks(numberOfYTicks);function xValueScaled(d,i){return x(i)}
var area=d3.svg.area().x(function(d,i){return x(i)}).y0(height).y1(function(d){return y(d[config.yField])});if(config.curved){area.interpolate("monotone")}
if(config.yField2){var area2=d3.svg.area().x(function(d,i){return x(i)}).y0(function(d){return y(d[config.yField])}).y1(function(d){return y(d[config.yField2]+d[config.yField])});if(config.curved){area2.interpolate("monotone")}}
var line=d3.svg.line().x(function(d,i){return x(i)}).y(function(d){return y(d[config.yField])});if(config.curved){line.interpolate("monotone")}
if(config.yField2){var line2=d3.svg.line().x(function(d,i){return x(i)}).y(function(d){return y(d[config.yField2]+d[config.yField])});if(config.curved){line2.interpolate("monotone")}}
var svg=d3.select(config.element).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.append("g").attr("class","y axis")
var areaSvg=svg.append("path").attr("class","area");if(config.areaFillColor){areaSvg.style("fill",config.areaFillColor)}
if(config.areaFillOpacity){areaSvg.style("fill-opacity",config.areaFillOpacity)}
if(config.yField2){var areaSvg2=svg.append("path").attr("class","area2");if(config.areaFillColor2){areaSvg2.style("fill",config.areaFillColor2)}
if(config.areaFillOpacity2){areaSvg2.style("fill-opacity",config.areaFillOpacity2)}}
var lineSvg=svg.append("path").attr("class","areaLine").style("fill","none");if(config.lineColor){lineSvg.style('stroke',config.lineColor)}
if(config.lineWidth){lineSvg.style('stroke-width',config.lineWidth)}
if(config.yField2){var lineSvg2=svg.append("path").attr("class","areaLine2").style("fill","none");if(config.lineColor2){lineSvg2.style('stroke',config.lineColor2)}
if(config.lineWidth2){lineSvg2.style('stroke-width',config.lineWidth2)}}
svg.append("g").attr("class","x axis").attr("transform","translate(0,"+(height)+")")
svg.append("g").attr("class","yNumbers")
$scope.data=function(data){var single=!1;var howManyDecimals=0;var seeMaxTick=config.seeMaxTick;if(data.length==1){single=!0;seeMaxTick=!0;var obj={};$.extend(obj,data[0])
data.push(obj)}else if(data.length==0){return !1}
function sortByDateAscending(a,b){return a[config.xField]-b[config.xField]}
data.forEach(function(d){if(config.xIsMysqlDate){console.log("it aint a date");d[config.xField]=kendo_DateHelper.getDateFromIsoFormat(d[config.xField])}else{console.log("it is a date")
d[config.xField]=d[config.xField]}
d[config.yField]=+d[config.yField];d[config.yField2]=+d[config.yField2]});data=data.sort(sortByDateAscending);x.domain([0,data.length-1]);var brTikova=data.length-1;var pomakZaPrvogIzadnjeg=30;var jedanTickZauzima=40;var maxBrojTikova=($('body').width()-pomakZaPrvogIzadnjeg)/40;if(brTikova>maxBrojTikova){brTikova=maxBrojTikova}
var danMje7=d3.time.format("%d %b, %y");xAxis.tickSize(0,0,0);xAxis.ticks(brTikova).tickFormat(function(v,i){var dat=danMje7(data[v][config.xField]);return dat});var yMin=d3.min(data,function(d){return d[config.yField]});var yMax=d3.max(data,function(d){return d[config.yField]});if(config.yField2){yMax=d3.max(data,function(d){return d[config.yField]+d[config.yField2]})}
var yTicks=4;if(single||yMax==yMin){yMin=0}
yMax=yMax+1;function stepY(min,max,single){if(config.roundXTicks){var step=Math.floor((max-min)/yTicks);if(step==0){howManyDecimals=0;step=max-min-1;if(step==0){config.roundXTicks=!1}}}
if(!config.roundXTicks){if(seeMaxTick){var step=Math.floor((max-min)/yTicks);if(step==0){howManyDecimals=1;step=Math.floor(((max-min)/yTicks)*10)/10;if(step==0){step=Math.floor(((max-min)/yTicks)*100)/100;howManyDecimals=2;if(step==0){step=Math.floor(((max-min)/yTicks)*1000)/1000;howManyDecimals=3}}}}else{var step=Math.round((max-min)/yTicks);if(step==0){step=Math.round(((max-min)/yTicks)*10)/10;howManyDecimals=1;if(step==0){step=Math.round(((max-min)/yTicks)*100)/100;howManyDecimals=2;if(step==0){step=Math.round(((max-min)/yTicks)*1000)/1000;howManyDecimals=3}}}}}
return step==0?0.001:step}
y.domain([yMin,yMax]);y=yScale.range([height,0]);yAxis.tickSize(-width,0,0).tickValues(d3.range(yMin,yMax,stepY(yMin,yMax)))
if(config.yLabelFormat){yAxis.tickFormat(config.yLabelFormat(howManyDecimals))}
svg.selectAll(".area").data([data]);svg.selectAll(".area2").data([data]);svg.selectAll(".areaLine").data([data]);svg.selectAll(".areaLine2").data([data]);svg.selectAll(".x").call(xAxis);svg.selectAll(".y").transition(animationLength).call(yAxis);yAxis.tickSize(0,0,0)
svg.selectAll(".yNumbers").transition(animationLength).call(yAxis);svg.selectAll(".y .domain").remove();svg.selectAll(".y .tick text").remove();svg.selectAll(".yNumbers .tick  text").attr("transform","translate(60, -10)");var heightSvg=d3.select("body").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).attr("transform","translate("+0+","+9999+")").attr('id','heightSvg')
var getHiddenElementHeight=function(element){var tempId='tmp-'+Math.floor(Math.random()*99999);$(element).clone().css('position','absolute').css('height','auto').css('width','1000px').appendTo($('#heightSvg')).css('left','-10000em').addClass(tempId).show()
h=d3.select('#heightSvg text').node().getBBox().height;$('.'+tempId).remove()
return h}
var textCenterHeightMultipler=1.9;svg.selectAll(".x text").attr("transform",function(d){return "translate("+getHiddenElementHeight(this)/2.5+","+getHiddenElementHeight(this)*textCenterHeightMultipler+"),rotate(90)"})
var firstXg=svg.selectAll(".x g").first();firstXg.attr('transform','translate(10, 0)');var firstXgTick=svg.selectAll('.x g line').first().attr('transform','translate(-4, 0)');var lastXg=svg.selectAll(".x g").last();var lastXgTransform=lastXg.attr('transform');lastXgTransform=lastXgTransform.split('(')[1];lastXgTransform=lastXgTransform.split(',')[0];lastXgTransform=parseFloat(lastXgTransform);var maxLastTrasformX=$('body').width()-1;if(lastXgTransform>maxLastTrasformX){lastXgTransform=maxLastTrasformX;lastXg.attr('transform','translate('+lastXgTransform+',0)')}
var lastText=svg.selectAll(".x g text").last();var heightText=getHiddenElementHeight(lastText.node());var luft=3;if((lastXgTransform+luft)>maxLastTrasformX){var textTransformX=maxLastTrasformX-(lastXgTransform+luft);lastText.attr('transform','translate('+textTransformX+','+heightText*textCenterHeightMultipler+'),rotate(90)')}
d3.select("#heightSvg").remove();svg.selectAll(".area").attr('transform','translate(0,'+height+'),scale(1,0)').attr("d",area).transition().duration(animationLength).attr('transform','translate(0,0),scale(1,1)')
svg.selectAll(".area2").attr('transform','translate(0,'+height+'),scale(1,0)').attr("d",area2).transition().duration(animationLength).attr('transform','translate(0,0),scale(1,1)')
svg.selectAll(".areaLine").attr('transform','translate(0,'+height+'),scale(1,0)').attr("d",line).transition().duration(animationLength).attr("d",line).attr("transform","translate(0,0),scale(1,1)");svg.selectAll(".areaLine2").attr('transform','translate(0,'+height+'),scale(1,0)').attr("d",line2).transition().duration(animationLength).attr("d",line2).attr("transform","translate(0,0),scale(1,1)")}
return $scope};function SortableList(config){var $scope={};var itemHeight=config.itemHeight;var numItems=config.numItems;var maxScrollY=itemHeight*numItems;var IscrollFixAddHeight=config.IscrollFixAddHeight;var wrapper=$(config.container+' #wrapper')[0];var myScroll=new IScroll(wrapper,{useTransition:!0,preventDefault:!1});console.log("maxScrollY",maxScrollY);myScroll.refresh(maxScrollY+IscrollFixAddHeight,0,0,0);var list=$(config.container+' #slipList')[0];var slip=new Slip(list);slip.maxScrollY=maxScrollY-config.containerHeight;slip.scrollableContainer=$(config.container+'  #scroller')[0];$scope.refresh=function(num,containerHeight){numItems=num;containerHeight=containerHeight||config.containerHeight;maxScrollY=numItems*itemHeight;myScroll.refresh(maxScrollY,0,0,0);slip.maxScrollY=maxScrollY-config.containerHeight}
$scope.getComponents=function(){return{iscroll:myScroll,slip:slip}}
list.addEventListener('slip:beforereorder',function(e){myScroll._initEvents(!0);console.log("removed events");console.log("set slip y at:",myScroll.y);slip.currentScrollY=0-myScroll.y},!1);list.addEventListener('slip:reorder',function(e){e.target.parentNode.insertBefore(e.target,e.detail.insertBefore);myScroll._initEvents();myScroll.startY=0-slip.currentScrollY;myScroll.y=0-slip.currentScrollY;console.log("set iscroll startY at:",0-slip.currentScrollY)
myScroll.refresh(maxScrollY,0,0,0);console.log("returned false")},!1);return $scope};App.controller("ctrl_Kendo",function($scope){$scope.$on('$viewContentLoaded',function(){console.log("firstview....");console.log(kConnector.getFirstView());var app=new kendo.mobile.Application($('#kendoApp'),{transition:"none",initial:kConnector.getFirstView(),browserHistory:!1,hashBang:!1,webAppCapable:!0,init:function(e){},skin:"flat"});kConnector.setApp(app)})});App.controller("ctrl_FirstView",function($scope,$location,$q,$rootScope,model_Clicker){console.log("in first view");$rootScope.promiseDeviceRdy.then(function(){$rootScope.removeAppLoader();console.log("redirecting");console.log("after first view promise");var token=localStorage.getItem('token');if(token==null||token==''){$location.path("/notSignedIn")}else{var requestSync=!1;if(!VAR_DEVELOPMENT&&model_Clicker.getS1()){if(!window.localStorage.getItem("clickerDontSyncOnStart")){requestSync=!0}}
if(requestSync){$location.path('/downloadClicker')}else{$location.path("/main")}}})});App.controller("ctrl_Menu",function($scope,svc_File,$q,svc_FileChecker){$scope.title="Canelio Tricks"
var def=$q.defer();def.promise.then(function(groups){$scope.groups=groups});svc_File.getAllTrickGroups(def)});App.controller("ctrl_Settings",function($scope,$q,$location,model_Login,model_Clicker){$scope.title="Settings";$scope.logout=function(){model_Login.clearData();$location.path("/notSignedIn")};$scope.refreshData=function(){var defer=$q.defer();defer.promise.then(function(sucess){alertify.success("Data refreshed")},function(fail){console.log("data failed to referesh")});model_Login.refreshData(defer)}
$scope.manualSync=function(){$location.path('/downloadClicker')}
$scope.clickerConnected=model_Clicker.getS1();$scope.clickerSyncOnStart=function(){var dontSyncAtStart=window.localStorage.getItem("clickerDontSyncOnStart");if(dontSyncAtStart){window.localStorage.removeItem("clickerDontSyncOnStart")}else{window.localStorage.setItem("clickerDontSyncOnStart",'1')}
console.log("called")}
$scope.disconnectClicker=function(){var def=$q.defer();def.promise.then(function(success){$scope.clickerConnected=!1});model_Clicker.disconnectClicker(def,{"smth":"smth"})}
$scope.clickerSyncOnStartClick=function(){$('#switchSyncStart').data('kendoMobileSwitch').toggle(!0);$scope.clickerSyncOnStart()}
var checked=window.localStorage.getItem("clickerDontSyncOnStart");console.log(checked);if(!checked){checked=!0}else{checked=!1}
$('#switchSyncStart').kendoMobileSwitch({onLabel:'Yes',offLabel:'No',checked:checked,})});App.controller("ctrl_Main",function($scope,$q,$location,stringHelper,model_Clicker,model_Level,model_ResultUpload,model_UploadDogImage,model_Dog,model_GoalDaily,model_GoalWeekly,model_ServerSync,model_Clicker){console.log(moment().unix())
svc_AngularHistory.clearRoutes();$scope.dogName=stringHelper.formatWith3Dots(model_Dog.getDogName(),14,210,$('body').width()-110);var blockSettings=!1;$scope.serverSync=model_ServerSync.isSyncNeeded();$scope.clickerSync=model_Clicker.getSyncRequired();$scope.goToClickerUpload=function(){$location.path('/downloadClicker')}
var lvlData=model_Level.getLevelPoints();$scope.pointsNeeded=lvlData.pointsNeeded;$scope.levelText=lvlData.nextLvl;$scope.maxLevelReached=lvlData.maxLevel;$scope.pointsText=lvlData.pointsText;$scope.maxLevelReached=!1;$scope.LevelBarStyle=function(){var width=lvlData.lvlPercentage*100;if(width<3){width=5}else if(width>98){width=98}
console.log(width);return{width:width+'%'}}
$scope.weeklyDone=0;$scope.weeklyPercentage=0;var defWeekly=$q.defer();defWeekly.promise.then(function(data){$scope.weeklyProgress=data;if($scope.weeklyProgress){$scope.weeklyDone=$scope.weeklyProgress.goalDone;if(!$scope.weeklyDone){$scope.weeklyDone==0}
$scope.weeklyPercentage=Math.floor(($scope.weeklyDone/$scope.weeklyProgress.goal)*100)}});model_GoalWeekly.getGoalProgress(defWeekly);$scope.weeklyBarStyle=function(){if($scope.weeklyPercentage>100){return{width:'100%',borederRadius:'0px!important'}}else{return{width:$scope.weeklyPercentage+'%'}}}
$scope.dailyDone=0;$scope.dailyPercentage=0;var defDaily=$q.defer();defDaily.promise.then(function(data){$scope.dailyProgress=data;if($scope.dailyProgress){$scope.dailyDone=$scope.dailyProgress.goalDone;if(!$scope.dailyDone){$scope.dailyDone=0}
$scope.dailyPercentage=Math.floor(($scope.dailyDone/$scope.dailyProgress.goal)*100)}});model_GoalDaily.getGoalProgress(defDaily);$scope.dailyBarStyle=function(){if($scope.dailyPercentage>100){return{width:'100%',borederRadius:'0px!important'}}else{return{width:$scope.dailyPercentage+'%'}}}
model_Dog.getDogImage().then(function(src){console.log("main image src-----------------------");console.log(src);$scope.dogImage=src},function(error){});$scope.changeProfilePic=function(){config={type:"profile"};model_UploadDogImage.setConfig(config);$location.path('/imageUpload')}
$scope.goToTrainMenu=function(){$location.path('/trainMenuSimple')}
$scope.goToSettings=function(){$location.path('/settings')}
$scope.goToUpload=function(){if(navigator.connection.type==Connection.NONE){alertify.error("Please connect to internet")}else{$location.path('/uploadToServer')}}
$scope.goToLevelDetails=function(){$location.path('/levelDetails')}
$scope.getLiWidth=function(){return{width:$('body').width()+'px'}}
$scope.goToResultsUpload=function(){var data=[];for(var i=0;i<5;i++){var trickID=41;if(i==0){trickID=41}else if(i==1){trickID=42}else if(i==2){trickID=43}else if(i==3){trickID=44}else if(i==4){trickID=46}
var training={time:moment().unix(),timesTrained:150,timesSuccess:20,trick_id:trickID};data.push(training)}
var def=$q.defer();def.promise.then(function(data){console.log("data is");console.log(data);data.level=[data.level];data.showSucessRates=!0
data.tricks=[{name:'Sit',success:'156',total:'212'},{name:'Stay',success:'50',total:'367'},{name:'Lay',success:'80',total:'157'},{name:'Fetch',success:'90',total:'243'},{name:'Clicker training',success:'18',total:'18'}];console.log("data 2 is");console.log(data.tricks);model_ResultUpload.setResult(data);$location.path('/resultUpload')});model_ServerSync.uploadTraining(def,data)}
$scope.setClicker=function(){var clickerData={time:moment().unix(),s1:'0000000000001',s2:[100,98,52,101,48,52,49,100,50,50,98,99,100,50,99,52]};alertify.success("claim clicker");model_Clicker.saveClicker(clickerData)}});App.controller("ctrl_TrainMenuSimple",function($scope,$q,$location,model_Tricks,model_Clicker){$scope.title="behaviours";$scope.reorderingNotAllowed=model_Clicker.getSyncRequired();if(!window.localStorage.getItem('tutorialTricks')){$scope.tricksTutorialShow=!0}
$scope.closeTutorial=function(){$scope.tricksTutorialShow=!1;if($scope.tricksTutorial){window.localStorage.setItem('tutorialTricks','true')}}
$scope.clickedLabel=function(){$scope.tricksTutorial=!$scope.tricksTutorial};$scope.$on('$viewContentLoaded',function(){var def=$q.defer();def.promise.then(function(data){$scope.tricks=data;initScrollView()});model_Tricks.getTricks(def,{})});$scope.checkIfReoderingAllowed=function(type,dontAlert){if($scope.reorderingNotAllowed){if(!dontAlert){alertify.error("Go to phone settings and Sync Clicker before "+type+" tricks")}
return !1}else{return !0}}
$scope.goToachievments=function(){if(navigator.connection.type==Connection.NONE){alertify.error("Please connect to internet")}else{kConnector.setFirstView("pages/extras/achivement/achievmentsListView.html");$location.path("/kendo")}}
$scope.createTrick=function(){if(navigator.connection.type==Connection.NONE){alertify.error("Please connect to internet")}else{$location.path('/createTrick')}}
function addLedContainers(){$('#mainMenuList #slipList li').each(function(index,li){if(index<5){var num=index+1;var ledice='<div class="ledContainer '+'led'+num+'"></led>';$(li).append(ledice)}})}
function pushReoder(){var trickOrder=[];$('#mainMenuList #slipList li').each(function(index,li){var trick={'id':$(li).attr('trickid'),'trick_id':$(li).attr('trickid'),'ordinal':index+1,'name':$(li).attr('trickName')}
trickOrder.push(trick)});model_Tricks.pushReorder(trickOrder)}
function initScrollView(){$($scope.tricks).each(function(index,el){var text='<li class="menuLink" trickid="'+el.id+'" trickName="'+el.name+'">'+el.name+'</li>';$('#mainMenuList #slipList').append(text)});addLedContainers();var listHeight=$('body').height()-96;var config={itemHeight:60,numItems:$scope.tricks.length,container:'#mainMenuList ',containerHeight:listHeight,IscrollFixAddHeight:0,}
$('#mainMenuList').css('height',listHeight+'px');var scrollProgress=!1;$('#mainMenuList li').on('click',function(e){if(!scrollProgress){var id=$(this).attr('trickid');var name=$(this).attr('trickName');var route='/trick/'+id+'/'+name;$scope.$apply(function(){$location.path(route)})}});var sortableList=new SortableList(config);var iscroll=sortableList.getComponents().iscroll;iscroll.on('scrollStart',function(){scrollProgress=!0})
iscroll.on('scrollEnd',function(){scrollProgress=!1})
$('#mainMenuList #slipList')[0].addEventListener('slip:swipe',function(e){if(!$scope.checkIfReoderingAllowed('deleting')){return null}
var target=e.target;var id=$(target).attr('trickid');var name=$(target).attr('trickName');$scope.$apply(function(){$location.path('/deleteTrick/'+id+'/'+name)})},!1);$('#mainMenuList #slipList')[0].addEventListener('slip:beforereorder',function(e){if(!$scope.checkIfReoderingAllowed('reordering')){e.preventDefault();return null}
$('#mainMenuList').addClass('mainMenuListSorting');$('#mainMenuList #slipList li .ledContainer').remove()},!1);$('#mainMenuList #slipList')[0].addEventListener('slip:reorder',function(e){console.log("reoder called");$('#mainMenuList').removeClass('mainMenuListSorting');addLedContainers();pushReoder()},!1);$('#mainMenuList #slipList')[0].addEventListener('slip:cancelreorder',function(e){$('#mainMenuList').removeClass('mainMenuListSorting');addLedContainers()},!1)}});App.controller("ctrl_Extras",function($scope,svc_File,$q,svc_FileChecker,$location){$scope.title="Extras Menu"
$scope.achievments=function(){kConnector.setFirstView("pages/extras/achivement/achievmentsListView.html");$location.path("/kendo")}});(function($,console,win){var $scope=kendo.observable({title:"Achievement list",loading:!0,noAchivements:!1,source:null,navigateBack:function(){kConnector.navigateBack()},createDataSource:function(total){var navHeight=$('#navBarSpaceFiller').height();var bodyHeight=$('body').height();var lineHeight=150;var nmLines=Math.ceil((bodyHeight-navHeight)/lineHeight);console.log("nm lines is:",nmLines);$scope.source=new kendo.data.DataSource({serverPaging:!0,pageSize:nmLines*7,page:1,schema:{total:function(abc){return total},},transport:{read:function(options){var def=$.Deferred()
def.promise().then(function(data){console.log(data);var $body=angular.element(document.body);var $string_helper=$body.injector().get('stringHelper');for(var i=0;i<data.length;i++){data[i].trickName=$string_helper.formatWith3Dots(data[i].trickName,18,320,320)}
options.success(data)},function(error){console.log("erorr");options.error(error)});console.log("-------------");console.log(options.data);kmodel_Achivement.getAchivements(def,options.data)}},});$scope.createListView()},createListView:function(){$("#achivementListView .achivmentList").kendoMobileListView({template:kendo.template($("#achivementListTemplate").html()),endlessScroll:!0,dataSource:$scope.source,virtualViewSize:20,click:function(e){console.log((e));kConnector.navigate("pages/extras/achivement/singleAchivement.html",{id:e.dataItem.id,trickId:e.dataItem.trickId},"slide:left")},})},loaderPadding:function(e){var height=$('#achivementListView .loadingContainer').outerHeight();return(($('body').height()-height)/2)+'px'},noAchivmentMessagePadding:function(e){var height=$('#achivementListView .noAchivemntsMessage').outerHeight();return(($('body').height()-height)/2)+'px'},beforeShow:function(){},show:function(e){$scope.set("loading",!0);var def=$.Deferred()
var datasourcePromise=def.promise();datasourcePromise.then(function(data){console.log("Dataa is---------------");console.log(data);if(data==0){$scope.set("noAchivements",!0)}
$scope.set("loading",!1);$scope.createDataSource(data)},function(error){});kmodel_Achivement.achivementsNumber(def,null)},init:function(e){}});$.extend(window,{kctrl_achivementList:$scope,})})(jQuery,console,window);(function($,console,win){var $scope=kendo.observable({achivementID:0,title:"Achievement",id:"0",trickId:"0",picTaken:!0,imageSrc:'',daysBetween:"1",dogName:localStorage.getItem("dogName"),loading:!0,chartSuccessDataSource:new kendo.data.DataSource({}),uploadPic:function(){config={type:'achivement',trickId:$scope.trickId};kmodel_UploadDogImage.setConfig(config);kConnector.navigateAngular('/imageUpload')},navigateShare:function(){kConnector.navigateAngular('/share/achievmenet/'+$scope.id)},navigateBack:function(){kConnector.navigateBack()},beforeShow:function(e){$scope.set("loading",!0)},show:function(e){$scope.id=e.view.params.id;$scope.trickId=e.view.params.trickId;console.log("-----------------------");console.log($scope.id);var def=$.Deferred()
var promise=def.promise();promise.then(function(data){console.log("got data");console.log(data);$scope.set("imageSrc",data.imageSrc);$scope.set("picTaken",data.hasImage);$scope.set('daysBetween',kendo_DateCalculationsHelper.daysBetween(data.date,data.startDate))
var statistics=kmodel_TrickStatistics.formatTrickSatistics(data.statistic.data);console.log("---------");console.log(statistics);$scope.set("points",kmodel_Points.calculatePoints(statistics.totalSuccess,statistics.totalFailed));$scope.set("repetitions",statistics.totalSuccess+statistics.totalFailed)
$scope.chart.data(statistics.sucessRates);$scope.set("loading",!1);var scrollview=$("#achivementSingle #scrollview").data("kendoMobileScrollView");scrollview.scrollTo(0,!0);scrollview.refresh()},function(error){});var data={'achivmentId':$scope.id};kmodel_Achivement.singleData(def,data)},init:function(e){console.log("init called");var marginTop=10;var height=$('body').height()-$('#navBar').height()-40-marginTop;$('#achivementSingle .achivemntBigPhotoContainer').css('height',height+'px');$('#achivementSingle .achivemntBigPhotoContainer').css('margin-top',marginTop+'px');$('#achivementSingle #successChart').css('width',$('body').width()-10+'px');var height=$('body').height()-85;var chartHeight=height-105;if(chartHeight>300){chartHeight=300}
var headerHeight=$('#achivementSingle #navBarSpaceFiller').height();var space=Math.floor((height-chartHeight-55)/2)
$('#achivementSingle .sucessRateLegend').css('margin-top',space+'px');var config=kendo_ChartHelper.d3SuccessConfig();config.element='#achivementSingle #successChart';config.height=chartHeight;$scope.chart=new d3AreaChart(config);var $body=angular.element(document.body);var model_Dog=$body.injector().get('model_Dog');var stringHelper=$body.injector().get('stringHelper');var dogName=stringHelper.formatWith3Dots(model_Dog.getDogName(),20,256,$('body').width()*0.8)}});$.extend(window,{kctrl_achivementSingle:$scope,})})(jQuery,console,window);App.controller("ctrl_Weight",function($scope,svc_File,$q,svc_FileChecker,$location){$scope.title="Weight"
$scope.promjenaDate=function(){var num=4;var data=[];var start=new Date(2011,0,8);var end=new Date();for(var i=0;i<num;i++){var obj={a:new Date(start.getTime()+Math.random()*(end.getTime()-start.getTime())),b:Math.round(Math.random()*30)+5,c:Math.round(Math.random()*25)+5,key:Math.round(Math.random())}
data.push(obj)}
$scope.chart.data(data)}
config={xIsMysqlDate:!1,xField:"a",yField:"b",yField2:"c",element:'#wieghtChart',curved:!1,height:300,seeMaxTick:!0,areaFillColor:'#871326',areaFillOpacity:'0.8',areaFillColor2:'#134787',areaFillOpacity2:'0.8',lineColor:'#900112',lineWidth:'2',lineColor2:'#062244',lineWidth2:'2',yLabelFormat:function(howManyDecimals){return function(v,i){return v.toFixed(howManyDecimals)}}};$scope.chart=new d3AreaChart(config)});App.controller("ctrl_WeightLog",function($scope,svc_File,$q,svc_FileChecker,$location){$scope.title="Log weight"
$scope.mainNav_datePicker_click=function(){console.log("clicked");$scope.showDatesPicker=!$scope.showDatesPicker}
$scope.mainNav_history_click=function(){kConnector.setFirstView("pages/extras/weight/weightHistory.html");$location.path("/kendo")}
$scope.decimalInput_save=function(weight){var number=$('.decimalInputContainer .input').text();$scope.decimalInput_reset();$scope.loadingMessage="Saving data...";$scope.loading=!0;var def=$q.defer();def.promise.then(function(data){console.log("sucess");$scope.datesChanged($scope.from,$scope.to)},function(error){console.log("error")});console.log("sending");console.log($('.decimalInputContainer .input').text());kmodel_Weight.save(def,number)};$scope.datesChanged=function(from,to){$scope.from=from;$scope.to=to;$scope.loading=!0;$scope.loadingMessage="Getting data...";data={from:from,to:to,};var def=$q.defer();def.promise.then(function(data){$scope.loading=!1;$scope.data=data;if(data.length>0){$scope.currentWeight=parseFloat(data[data.length-1].weight);$scope.currentWeight=Math.abs($scope.currentWeight.toFixed(5))}else{$scope.currentWeight=0}
if(data.length>1){$scope.changeAvaliable=!0;$scope.oneDataEntry=!1;var last=data[data.length-1];var before=data[data.length-2];$scope.change=parseFloat(last.weight)-parseFloat(before.weight);$scope.change=Math.abs($scope.change.toFixed(5));if($scope.change>0){$scope.changeUp=!0;$scope.changeDown=!1}else if($scope.change<0){$scope.changeUp=!1;$scope.changeDown=!0}else{$scope.changeUp=!1;$scope.changeDown=!1}}else{$scope.oneDataEntry=!0;$scope.changeAvaliable=!1}
$scope.chart.data(data)},function(error){console.log("error")});kmodel_Weight.getData(def,data)}
var currentWeightContinerHeight=90;var latestChangeContainerHeight=80;var navBarHeight=50;var avaliableSpace=$('body').height()-navBarHeight;console.log("body height",$('body').height());console.log("navbar height",navBarHeight)
var maxChartHeight=340;var chartHeight=avaliableSpace-currentWeightContinerHeight-latestChangeContainerHeight;if(chartHeight>maxChartHeight){chartHeight=maxChartHeight}
console.log("chart height is",chartHeight);$scope.changeAvaliable=!0;$scope.chartStyle=function(){var bottom=avaliableSpace-currentWeightContinerHeight-chartHeight;if($scope.changeAvaliable||($scope.oneDataEntry&&$scope.currentWeight)){bottom=bottom-latestChangeContainerHeight}
bottom=Math.floor(bottom/2);return{bottom:bottom}}
config={xIsMysqlDate:!0,xField:"date",yField:"weight",element:'#wieghtChart',curved:!0,height:chartHeight,seeMaxTick:!0,areaFillColor:'#134787',areaFillOpacity:'0.8',lineColor:'#062244',lineWidth:'2',yLabelFormat:function(howManyDecimals){return function(v,i){return v.toFixed(howManyDecimals)}}};$scope.chart=new d3AreaChart(config)});(function($,console,win){var $scope=kendo.observable({achivementID:0,title:"Weight History",loading:!0,createDataSource:function(total){var navHeight=$('#navBarSpaceFiller').height();var bodyHeight=$('body').height();var lineHeight=80;var tapToDeleteHeight=32;var nmLines=Math.ceil((bodyHeight-navHeight-tapToDeleteHeight)/lineHeight);console.log("nm lines is:",nmLines);$scope.source=new kendo.data.DataSource({serverPaging:!0,pageSize:nmLines*7,page:1,schema:{total:function(abc){return total},},transport:{read:function(options){var def=$.Deferred()
def.promise().then(function(data){data.forEach(function(d){d.weight=Math.abs(parseFloat(d.weight).toFixed(5))});console.log(data);options.success(data)},function(error){console.log("erorr");options.error(error)});console.log("-------------");console.log(options.data);kmodel_Weight.getWeighPaged(def,options.data)}},});$scope.createListView()},createListView:function(){console.log("creating listview");$("#weightHistory .historyList").kendoMobileListView({template:kendo.template($("#weightHistoryTemplate").html()),endlessScroll:!0,dataSource:$scope.source,click:function(e){e.preventDefault();$('#weightHistoryModal').data('kendoMobileModalView').open();$scope.set("date",e.dataItem.date);$scope.set("weight",e.dataItem.weight);$scope.set("itemForDelete",e.dataItem)},});console.log("creating listview")},modalLoading:!1,closeModalView:function(){$('#weightHistoryModal').data('kendoMobileModalView').close()},deleteEntry:function(){$scope.set("modalLoading",!0);var dataItem=$scope.get("itemForDelete");var data={id:dataItem.id};var def=$.Deferred()
var promise=def.promise();promise.then(function(data){$scope.set("modalLoading",!1);var listview=$("#weightHistory .historyList").data("kendoMobileListView");$scope.source.remove(dataItem);listview.remove([dataItem]);listview.refresh();$('#weightHistoryModal').data('kendoMobileModalView').close()},function(error){$scope.set("modalLoading",!1)});kmodel_Weight.deleteWeight(def,data);$('#weightHistoryModal').data('kendoMobileModalView').close()},navigateBack:function(){kConnector.navigateBack()},beforeShow:function(e){$scope.set("loading",!0)},show:function(e){},init:function(e){$scope.set("loading",!0);var def=$.Deferred()
var datasourcePromise=def.promise();datasourcePromise.then(function(data){if(data==0){$scope.set("noAchivements",!0)}
$scope.set("loading",!1);$scope.createDataSource(data)},function(error){});kmodel_Weight.getWeighCount(def,null)}});$.extend(window,{kctrl_WeightHistory:$scope,})})(jQuery,console,window);App.controller("ctrl_trainMenu",function($scope,$q){$scope.title="train menu"});App.controller("ctrl_myTricks",function($scope,svc_File,$q,svc_FileChecker,$location){$scope.title="My tricks"
$scope.createTrick=function(){$location.path("/createTrick")}
$scope.mainNav_delete_click=function(){$scope.deleteMode=!$scope.deleteMode}
var def=$q.defer();$scope.datasourcePromise=def.promise;$scope.datasourcePromise.then(function(data){if(data==0){$scope.noTricks=!0}
$scope.createDatasource(data)},function(error){});kmodel_MyTricks.nmTricks(def,null);var nmLines=Math.ceil(($('body').height()-50-60)/50);$scope.createDatasource=function(total){$scope.source=new kendo.data.DataSource({serverPaging:!0,pageSize:nmLines*6,page:1,schema:{total:function(abc){return total},},transport:{read:function(options){console.log("-------------");console.log(options);var def=$q.defer();def.promise.then(function(data){console.log("!!!!!!!!!!!!!!! resolving success");console.log(data);options.success(data)},function(error){console.log("erorr");options.error(error)});kmodel_MyTricks.getTricks(def,options.data)}},})};$scope.deleteConfirm=function(){if($scope.block){return null}
$scope.deleteModalLoading=!0;var data={id:$scope.trickId};var dataItem=$scope.dataItem;var def=$.Deferred()
var promise=def.promise();promise.then(function(data){$scope.deleteModalLoading=!1;var listview=$("#myTricks #trickList").data("kendoMobileListView");$scope.source.remove(dataItem);listview.remove([dataItem]);listview.refresh();$('#myTricksDeleteModal').data('kendoMobileModalView').close()},function(error){$scope.deleteModalLoading=!1});kmodel_MyTricks.deleteTrick(def,data);$('#myTricksDeleteModal').data('kendoMobileModalView').close()}
$scope.deleteCancel=function(){if($scope.block){return null}
$('#myTricksDeleteModal').data('kendoMobileModalView').close()}
$scope.$on('$viewContentLoaded',function(){console.log(1);var app=new kendo.mobile.Application($('#kapp'),{transition:"slide",initial:"#myTricks",browserHistory:!1,webAppCapable:!1,init:function(e){console.log("1111111111111111111111111111")},skin:"flat"});$scope.datasourcePromise.then(function(data){console.log(2);$scope.listView=$("#trickList").kendoMobileListView({dataSource:$scope.source,template:kendo.template($("#trickTemplate").html()),endlessScroll:!0,click:function(e){console.log(e.dataItem);if($scope.deleteMode){console.log("--------------");console.log(e.dataItem.name);$scope.$apply(function(){$scope.deleteModalLoading=!1;$scope.trickName=e.dataItem.name;$scope.trickId=e.dataItem.id;$scope.dataItem=e.dataItem});$scope.block=!0;setTimeout(function(){$scope.block=!1},300)
console.log($scope.trickName);$('#myTricksDeleteModal').data('kendoMobileModalView').open()}else{$scope.$apply(function(){var id=e.dataItem.id;$location.path("/train/1/"+id)})}}})},function(error){console.log("error")})})});App.controller("ctrl_createTrick",function($scope,svc_File,$q,svc_FileChecker,$location,$rootScope){$scope.title="Create Trick"
$scope.createTrick=function(){if($scope.trickName==''||$scope.trickName==' '||$scope.trickName==null){alertify.error("please enter trick name");return null}
data={name:$scope.trickName,created:kendo_DateHelper.getCurrentTimestamp()};console.log(data);var def=$.Deferred()
var promise=def.promise();promise.then(function(data){$rootScope.goBack()},function(error){alertify.error("trick failed to create")});kmodel_MyTricks.createTrick(def,data)}});App.controller("ctrl_deleteTrick",function($scope,$q,$location,$rootScope,$routeParams){$scope.trickId=$routeParams.id;$scope.trickName=$routeParams.name;$scope.deleteCancel=function(){$rootScope.goBack()}
$scope.deleteTrick=function(){var def=$q.defer();def.promise.then(function(){$rootScope.goBack()},function(){alertify.error("failed to delete trick")})
data={trick_id:$scope.trickId};kmodel_MyTricks.deleteTrick(def,data)}});App.controller("ctrl_Trick",function($scope,svc_File,db_Trainig,$location,$q,$routeParams,stringHelper,model_Tricks,model_UploadDogImage){$scope.trickId=$routeParams.id;$scope.title=stringHelper.replaceSpaces($routeParams.name);$scope.costumeTrick=!0;var def=$q.defer();def.promise.then(function(trick){$scope.costumeTrick=!1});svc_File.getTrick(def,$routeParams.id);var def2=$q.defer();def2.promise.then(function(data){console.log($scope.trickId);console.log("level is",data);$scope.achivmentLevel=data.level;$scope.fulltitle=kmodel_Achivement.getTitleForLevel($scope.achivmentLevel,$scope.title);console.log($scope.fulltitle);$scope.achivmentTitle=stringHelper.formatWith3Dots($scope.fulltitle,25,320,$('body').width());if($scope.achivmentLevel==1){$scope.trophy1='res/trophies/trophy1.png'}else if($scope.achivmentLevel==2){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png'}else if($scope.achivmentLevel==3){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png';$scope.trophy3='res/trophies/trophy3.png'}else if($scope.achivmentLevel==4){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png';$scope.trophy3='res/trophies/trophy3.png';$scope.trophy4='res/trophies/trophy4.png'}},function(data){$scope.goOffline=!0});var data={trickId:$scope.trickId};kmodel_Achivement.achivmentLevel(def2,data);var def3=$q.defer();def3.promise.then(function(data){console.log(data);if(data.hasImage){$scope.imageSrc=data.imageSrc}else{console.log("set it");$scope.imageSrc="res/logo062244White.png"}});var dataTrick={trickId:$scope.trickId};model_Tricks.getTrickImage(def3,dataTrick);var def=$q.defer();def.promise.then(function(trick){$scope.costumeTrick=!1});svc_File.getTrick(def,$routeParams.id);var defStats=$q.defer();defStats.promise.then(function(trick){console.log("trick is");console.log(trick);if(trick.timesTrained==null){trick.timesTrained=100}
if(trick.timesSuccess==null){trick.timesSuccess=50}
$scope.success=Math.round((trick.timesSuccess/trick.timesTrained)*100);$scope.fail=100-$scope.success;$('#successBar').css('width',$scope.success+'%');$('#failBar').css('width',$scope.fail+'%')});db_Trainig.getTrickTotal(defStats,{trickId:$routeParams.id});$scope.goToInstructions=function(){if($scope.costumeTrick){alertify.error("There are no instructions for custome tricks")}else{$location.path('/instructions/'+$scope.trickId)}}
$scope.goToStatistics=function(){$location.path('/statistics/trick/'+$scope.trickId)}
$scope.uploadDogImage=function(){config={type:"achivement",trickId:$scope.trickId};model_UploadDogImage.setConfig(config);$location.path('/imageUpload')}
$scope.goToAchivment=function(){console.log($scope.trickId);console.log($routeParams.name);$location.path('/as/'+$scope.trickId+'/'+$routeParams.name)}});App.controller("ctrl_Help",function($scope,svc_File,$q,$routeParams){$scope.trickId=$routeParams.id;$scope.title="help"});App.controller("ctrl_HandSignal",function($scope,svc_File,$q,$routeParams){$scope.trickId=$routeParams.id;$scope.title="Hand Signal";var def=$q.defer();def.promise.then(function(file){$scope.handSignal=file.handSignal});svc_File.getTrick(def,$routeParams.id);$scope.containerStyle=function(){return{top:$('#navBarSpaceFiller').height()+'px',height:$('body').height()-$('#navBarSpaceFiller').height()+'px'}}});App.controller("ctrl_Instructions",function($scope,svc_File,$q,$routeParams){$scope.trickId=$routeParams.id;$scope.title="Instructions";var def=$q.defer();def.promise.then(function(file){console.log(file);$scope.steps=file.steps;console.log($scope.steps)});svc_File.getTrick(def,$routeParams.id);$scope.containerStyle=function(){return{top:$('#navBarSpaceFiller').height()+'px',height:$('body').height()-$('#navBarSpaceFiller').height()+'px'}}
$scope.$on('$viewContentLoaded',function(){var app=new kendo.mobile.Application($('#kapp'),{transition:"none",initial:"#instructions",browserHistory:!1,webAppCapable:!1,skin:"ios-light"})})});App.controller("ctrl_Solutions",function($scope,svc_File,$q,$routeParams){console.log("inside Solution");$scope.problemsTxt="Problems";$scope.advicesTxt="Advices";$scope.title="Advices";$scope.getTabIconSrc=function(tab){if(tab=='advice'){if(!$scope.isProblemsActive){return 'res/advices2b605f.png'}else{return 'res/advicesWhite.png'}}else if(tab=='problems'){if($scope.isProblemsActive){return 'res/problems2b605f.png'}else{return 'res/problemsWhite.png'}}
return !1}
$scope.tabChange=function(isProblems){$scope.isProblemsActive=isProblems;$scope.app.view().scroller.reset()}
$scope.tabsSpacer={width:Math.floor(window.innerWidth-157)/3+'px'}
$scope.problemClicked=function(problem){if($scope.block){return null}
problem.showFull=!problem.showFull}
$scope.isProblemClicked=function(problem){return problem.showFull}
$scope.isProblemsActive=!0;var def=$q.defer();def.promise.then(function(solution){$scope.problems=solution.problems;$scope.advices=solution.advice});svc_File.getTrickSolution(def,$routeParams.id);$scope.$on('$viewContentLoaded',function(){$scope.app=new kendo.mobile.Application($('#kapp'),{transition:"none",initial:"#solutions",browserHistory:!1,webAppCapable:!1,skin:"ios-light",init:function(){this.view().scroller.bind("scroll",function(e){console.log("scroll");clearTimeout($scope.timeout);$scope.timeout=setTimeout(function(){$scope.block=!1},100);$scope.block=!0})}})})});App.controller("ctrl_ImageUpload",function($scope,$q,model_UploadDogImage,$cordovaFile,$rootScope,$location){$scope.title='Upload picture';$scope.imageUploadConfig=kmodel_UploadDogImage.getConfig().type;$scope.navigateBack=function(){if($scope.imageUploadConfig!='achivement'){model_UploadDogImage.resetImages()}
$rootScope.goBack()}
var def=$q.defer();def.promise.then(function(data){console.log("resolved true");$scope.edit=data.exists;$scope.editLargeId=data.largeId},function(error){console.log("resolved false");$scope.edit=!1});model_UploadDogImage.checkForEdit(def);$scope.editClick=function(){$scope.duplicateImage($scope.editLargeId)}
$scope.cropCancel=function(){$rootScope.goBack()}
$scope.duplicateImage=function(largeId){$scope.loadingMessage="Getting photo...";$scope.loading=!0;var def=$q.defer();def.promise.then(function(data){$scope.src=data.src;$scope.uid=data.uid;$scope.imageDogId=data.imageDogId;$scope.initateCropper()},function(error){$scope.loading=!1});var data={largeId:largeId};model_UploadDogImage.duplicateImage(def,data)}
$scope.navigateGallery=function(){$location.path('/dogGallery')};$scope.cropSave=function(){console.log($scope.coords);$scope.loadingMessage="Cropping photo...";var data={x:$scope.coords.x,y:$scope.coords.y,width:$scope.coords.width,height:$scope.coords.height,uid:$scope.uid,imageDogId:$scope.imageDogId,};console.log(data);var def=$q.defer();def.promise.then(function(data){console.log("success");$scope.loading=!1;$scope.cropping=!1;model_UploadDogImage.setImages(data.src,$scope.src);$rootScope.goBack()},function(error){console.log("fail");$scope.loading=!1});model_UploadDogImage.cropImage(def,data)}
$scope.croppingModal=function(){if($scope.cropping){return{opacity:1}}
return{opacity:0}}
$scope.croppingArea=function(){return{width:'100%',height:$('body').height()-73+'px'}}
$scope.initateCropper=function(){$('#croppingContainer div').remove();$('#croppingContainer').append('<div><img id="naturalImage" /></div>');var img=document.getElementById('naturalImage');img.src=$scope.src;$("#naturalImage").one('load',function(){console.log("width is----------");console.log(img);console.log($("#naturalImage").width());console.log(img.naturalWidth);$("#naturalImage").cropper({done:function(data){$scope.coords=data},aspectRatio:1,minWidth:115,minHeight:115,zoomable:!1,resizable:!0,resize:!0,}).one("built"+".cropper",function(){console.log("built");$scope.$apply(function(){$scope.cropping=!0;$scope.loading=!1})})})}
$scope.uploadPhoto=function(imageData){console.log("upload photo in progress...");$scope.loading=!0;$scope.loadingMessage="Uploading photo...";var footerHeight=73;var avaliableHeight=$('body').height()-footerHeight;var avaliableWidth=$('body').width();var img=document.getElementById('naturalImage');var imgHeight=img.naturalHeight;var imgWidth=img.naturalWidth;var def=$q.defer();def.promise.then(function(data){console.log("success");console.log(data);$scope.src=data.src;$scope.uid=data.uid;$scope.imageDogId=data.imageDogId;$scope.initateCropper()},function(error){$scope.loading=!1});var data={img:imageData,targetWidth:$('body').width(),targetHeight:$('body').height()-73,};model_UploadDogImage.uploadImage(def,data)}
$scope.takeUserPhotoFailed=function(){alertify.error("Oops, something went wrong please try again")}
$scope.uploadFailed=function(){console.log("uploadFailedCalled")
$scope.$apply(function(){$scope.loading=!1;$scope.cropping=!1;console.log($scope.loading);console.log($scope.cropping);console.log("inside")})}
$scope.takeUserPhoto=function(t){var type;var edit;$scope.loading=!0;$scope.loadingMessage="Loading...";if(t=="gallery"){type=Camera.PictureSourceType.PHOTOLIBRARY;edit=!0}else{type=Camera.PictureSourceType.CAMERA;edit=!1}
navigator.camera.getPicture($scope.uploadPhoto,$scope.uploadFailed,{quality:100,destinationType:Camera.DestinationType.DATA_URL,sourceType:type,allowEdit:edit,encodingType:Camera.EncodingType.JPEG,correctOrientation:!0,targetWidth:$('body').width()*2,targetHeight:($('body').height()-73)*2,})}
var largeId=model_UploadDogImage.getImageLargeId();if(largeId){$scope.duplicateImage(largeId)}});App.controller("ctrl_DogGallery",function($scope,$q,$rootScope,model_Gallery,model_UploadDogImage){$scope.title="Gallery"
var lineHeight=($('body').width()/3)+10;var nmLines=($('body').height()-$('#navBarSpaceFiller').height())/lineHeight;nmLines=Math.ceil(nmLines);var def=$q.defer();$scope.datasourcePromise=def.promise;$scope.datasourcePromise.then(function(data){console.log("total is,",data);console.log("pageSize is:",nmLines*4);if(data==0){$scope.noImages=!0}
$scope.createDatasource(data)},function(error){});model_Gallery.getSizeDogImages(def,null);$scope.loadImage=function(largeId){model_UploadDogImage.setImageLargeId(largeId);$rootScope.goBack()}
$scope.createDatasource=function(total){$scope.source=new kendo.data.DataSource({serverPaging:!0,pageSize:nmLines*6,page:1,schema:{total:function(abc){return total},},transport:{read:function(options){console.log("-------------");console.log(options);var def=$q.defer();def.promise.then(function(data){console.log("!!!!!!!!!!!!!!! resolving success");console.log(data);options.success(data)},function(error){console.log("erorr");options.error(error)});model_Gallery.getDogImages(def,options.data)}},})};$scope.$on('$viewContentLoaded',function(){$scope.datasourcePromise.then(function(data){var app=new kendo.mobile.Application($('#kapp'),{transition:"none",initial:"#gallery",browserHistory:!1,webAppCapable:!1,init:function(e){console.log("1111111111111111111111111111")},skin:"ios-light"});$scope.listView=$(".gallery").kendoMobileListView({dataSource:$scope.source,template:kendo.template($("#template").html()),endlessScroll:!0,itemChange:function(e){console.log(2222222222222)},dataBound:function(e){console.log(3333333333)},dataBinding:function(e){console.log(4444444444444)},click:function(e){if(typeof $(e.target[0]).attr('largeid')!="undefined"){console.log("1223452");console.log($(e.target[0]).attr('largeid'));$scope.loadImage($(e.target[0]).attr('largeid'))}
console.log(e);console.log(555555555555555555)}})},function(error){console.log("error")})})});App.controller("ctrl_TrickStatistics",function($scope,$q,$routeParams,dateHelper,model_TrickStatistics,chartHelper){$scope.showDatesPicker=!1;$scope.title="Statistics";$scope.trickId=$routeParams.id;setTimeout(function(){$('#datesPicker').addClass('slideFadeInFromBottomOut')},400);$scope.viewAnimationDef=$q.defer();$scope.viewAnimationPromise=$scope.viewAnimationDef.promise;$scope.loading=!0;$scope.viewAnimationDef.resolve(!0);$scope.getTabIconSrc=function(tab){if(tab=='success'){if(tab==$scope.selcted){return 'res/statistics2b605f.png'}else{return 'res/statisticsWhite.png'}}else if(tab=='repetition'){if(tab==$scope.selcted){return 'res/repetitionsChart2b605f.png'}else{return 'res/repetitionsChartWhite.png'}}
return !1}
$scope.chartsRelativeContainer={"min-height":window.innerHeight-130}
$scope.tabSpacersWidth=function(){return{width:Math.floor(($('body')[0].getBoundingClientRect().width-$('#sucessRateTab')[0].getBoundingClientRect().width-$('#repetitionsTab')[0].getBoundingClientRect().width)/3)+'px'}}
$scope.select=function(tab){$scope.selcted=tab}
$scope.isSelected=function(tab){if(tab==$scope.selcted){return !0}
return !1}
$scope.datesChanged=function(from,to){$scope.loading=!0;$scope.noTrainingsDone=!1;console.log("got dates changed");console.log(from);console.log(to);var data={from:from,to:to,trick_id:$scope.trickId};var def=$q.defer();def.promise.then(function(data){if(data.length==0){$scope.loading=!1;$scope.noTrainingsDone=!0;return null}
$scope.viewAnimationPromise.then(function(success){console.log("data is:");console.log(data);var formatedData=model_TrickStatistics.formatTrickSatistics(data);console.log(formatedData.repetitions);$scope.repetitionsChart.data(formatedData.repetitions);$scope.successChart.data(formatedData.sucessRates);$scope.totalFailed=formatedData.totalFailed;$scope.totalSuccess=formatedData.totalSuccess;$scope.highestSucessRate=formatedData.highestSucessRate;$scope.loading=!1})},function(error){console.log(error)});model_TrickStatistics.getData(def,data)}
$scope.initTabs=function(){$scope.initRepetition();$scope.initSucess()}
var chartConteinerHeight=$('body').height()-130;var chartHeight=chartConteinerHeight-95;if(chartHeight>320){chartHeight=320}
$scope.singleChartHeight=function(){return{height:(chartHeight+95)+'px'}}
$scope.initRepetition=function(){var config=kendo_ChartHelper.d3RepetitionsConfig(chartHeight);$scope.repetitionsChart=new d3AreaChart(config)}
$scope.initSucess=function(){var config=kendo_ChartHelper.d3SuccessConfig(chartHeight);$scope.successChart=new d3AreaChart(config)}
$scope.mainNav_datePicker_click=function(){$scope.showDatesPicker=!$scope.showDatesPicker}
$scope.initTabs();$scope.select('success')});App.controller("ctrl_GroupStatistics",function($scope,$q,$routeParams,dateHelper,model_GroupStatistics,chartHelper,svc_File){$scope.playVideoTxt="Play Video";$scope.title="Statistics";$scope.groupId=$routeParams.id;$scope.level=$routeParams.level;var def=$q.defer();$scope.filePromise=def.promise;if($scope.level=="subgroup"){svc_File.getTrickSubGroup(def,$routeParams.id)}else{svc_File.getTrickGroup(def,$routeParams.id)}
$scope.viewAnimationDef=$q.defer();$scope.viewAnimationPromise=$scope.viewAnimationDef.promise;$scope.loading=!0;setTimeout(function(){$scope.viewAnimationDef.resolve(!0)},1000);$scope.getLegendIconColor=function(index){return{"background-color":SERIES_COLORS[index]}}
$scope.getTabIconSrc=function(tab){if(tab=='success'){if(tab==$scope.selcted){return 'res/statistics2b605f.png'}else{return 'res/statisticsWhite.png'}}else if(tab=='repetition'){if(tab==$scope.selcted){return 'res/repetitionsChart2b605f.png'}else{return 'res/repetitionsChartWhite.png'}}else if(tab=='share'){if(tab==$scope.selcted){return 'res/share2b605f.png'}else{return 'res/shareWhite.png'}}
return !1}
$scope.chartsRelativeContainer={"min-height":window.innerHeight-130}
$scope.tabSpacerWidth=function(){return{width:Math.floor(($('body')[0].getBoundingClientRect().width-$('#tabShare')[0].getBoundingClientRect().width-$('#tabRepetitions').outerWidth()-$('#tabSuccessRate')[0].getBoundingClientRect().width)/2)+'px'}}
$scope.select=function(tab){$scope.selcted=tab}
$scope.isSelected=function(tab){if(tab==$scope.selcted){return !0}
return !1}
$scope.datesChanged=function(from,to){$scope.loading=!0;$scope.noTrainingsDone=!1;$scope.from=from;$scope.to=to;var data={from:from,to:to,group_id:$scope.groupId};var def=$q.defer();def.promise.then(function(data){var def=$q.defer();def.promise.then(function(formattedData){$scope.viewAnimationPromise.then(function(success){$scope.chartSharesDatasource=formattedData.shares;$("#shareChart").data('kendoChart').setDataSource($scope.chartSharesDatasource);var obj=[];$.extend(!0,obj,formattedData.trainings);console.log("set chartSharesDatasource");console.log(obj);console.log(formattedData.trainings);$scope.shares=formattedData.shares;$scope.repetitionsChart.data(formattedData.trainings);$scope.successChart.data(obj);$scope.totalFailed=formattedData.totalFail;$scope.totalSuccess=formattedData.totalSuccess;$scope.highestSucessRate=formattedData.highestSucessRate;$scope.loading=!1;$scope.noTrainingsDone=!1})},function(error){if(error=="noData"){$scope.loading=!1;$scope.noTrainingsDone=!0}});model_GroupStatistics.formatGroupSatistics(def,$scope.filePromise,$scope.level,data)},function(error){console.log(error)});model_GroupStatistics.getData(def,$scope.level,data)}
var chartConteinerHeight=$('body').height()-130;var chartHeight=chartConteinerHeight-95;if(chartHeight>320){chartHeight=320}
$scope.chart={width:window.innerWidth,height:chartHeight-50}
$scope.singleChartHeight=function(){return{height:(chartHeight+95)+'px'}}
$scope.initTabs=function(){$scope.initRepetition();$scope.initSucess();$scope.initShares()}
$scope.initRepetition=function(){var config=kendo_ChartHelper.d3RepetitionsConfig(chartHeight);$scope.repetitionsChart=new d3AreaChart(config)}
$scope.initSucess=function(){var config=kendo_ChartHelper.d3SuccessConfig(chartHeight);$scope.successChart=new d3AreaChart(config)}
$scope.initShares=function(){var config=chartHelper.getChartConfig();config.legend.visible=!1;config.legend.labels.template='#= text # #= value#%\n',config.series=[{type:"donut",field:"value",categoryField:"name",startAngle:150,}];$("#shareChart").kendoChart(config)}
$scope.mainNav_datePicker_click=function(){$scope.showDatesPicker=!$scope.showDatesPicker}
$scope.initTabs();$scope.select('share')});App.controller("ctrl_NotLoggedInMain",function($scope,svc_File,$q,$location){svc_AngularHistory.clearRoutes();$scope.trackYourDogTrainingTxt="Track your dog training";$scope.loginTxt="Login";$scope.registerTxt="Register";console.log("inside");var token=localStorage.getItem('token');if(token!=null&&token!=''){$location.path('/main')}});App.controller("ctrl_Login",function($scope,$q,model_Login,$location,$rootScope,svc_FileChecker){$scope.forgotPassword="Forgot password?";$scope.loginTxt="Login";$scope.usernameTxt="username";$scope.passwordTxt="password";$scope.backTxt="back";$scope.login=function(){if($scope.email==''||$scope.email==null){alertify.error("please enter email");return null}
if($scope.password==''||$scope.password==null){alertify.error("please enter password");return null}
var def=$q.defer();def.promise.then(function(sucess){svc_FileChecker.checkFilesVersion()},function(error){alertify.error(error.message)});var data={email:$scope.email,password:$scope.password,}
model_Login.login(def,data)}
$scope.goBack=function(){$rootScope.goBack()}
$scope.passwordRetrival=PASSWORD_RETRIVAL});App.controller("ctrl_Register",function($scope,$location,$q,model_Register,$rootScope,svc_FileChecker){$scope.emailTxt="e-mail";$scope.passwordTxt="password";$scope.usernameTxt="username";$scope.dogBreedTxt="dog breed";$scope.dogNameTxt="dog name";$scope.promoCodeTxt="promo code";$scope.backTxt="back";$scope.nextTxt="next";$scope.registerTxt="Register";$scope.almostDoneTxt="Almost done...";$scope.step=0;$scope.nextButton=$scope.nextTxt;$scope.nextStep=function(){if($scope.step==0){if($scope.email==''||$scope.email==null){alertify.error("Please enter your email");return null}
if($scope.password==''||$scope.password==null){alertify.error("Please enter password");return null}
if($scope.dogName==''||$scope.dogName==null){alertify.error("Please enter your dog's name");return null}
var data={"password":$scope.password,"email":$scope.email,"dogName":$scope.dogName,};var def=$q.defer();def.promise.then(function(sucess){svc_FileChecker.checkFilesVersion()},function(error){console.log("error");console.log(error);if(error.errorCode==2){$scope.step=0;alertify.error("Email exists");alertify.error("Retrieve your password from login screen")}
if(error.errorCode==3){alertify.error("Invalid email");$scope.email='';$scope.step=0}});model_Register.register(def,data)}
$scope.step++}
$scope.prevStep=function(){if($scope.step==0){$rootScope.goBack()}
$scope.step--}});App.controller("ctrl_DownloadFiles",function($scope,model_DownloadFiles,$q,$routeParams,$http,$cordovaFile,$location){$scope.downloadingFilesTxt="Downloading Tricks...";$scope.pleaseWaitWeAreTxt="Please wait we are";$scope.code=$routeParams.code;$scope.downloaded=0;$scope.progressBarStyle=function(){return{"width":$scope.progress()}}
$scope.progress=function(){return Math.round(($scope.downloaded/$scope.total)*100)+' %'}
var def=$q.defer();def.promise.then(function(data){console.log("got full files list-------------");$scope.filesList=data.files;$scope.total=data.total;$scope.version=data.version;var def=$q.defer();def.promise.then(function(data){console.log("canelio dir created-------------");angular.forEach($scope.filesList,function(value,key){console.log("key is:",key);$cordovaFile.checkDir(VAR_MOBILE_FOLDER+key).then(function(success){console.log("checkDirResolved")
downloadFiles(key,value)},function(fail){var def=$q.defer();def.promise.then(function(success){downloadFiles(key,value)},function(fail){});model_DownloadFiles.createFolder(def,key)})},function(fail){console.log("failed to create canelio folder-------------")})});model_DownloadFiles.createCanelioFolder(def)},function(fail){console.log("failed to get full files list-------------")});model_DownloadFiles.getFullFilesList(def,localStorage.getItem('filesVersion'));function downloadFiles(dir,filesList){angular.forEach(filesList,function(file,key){$http.get(file.url).success(function(data,status,headers,config){var def=$q.defer();def.promise.then(function(success){$scope.downloaded++;$('downloadProgressPercentage').html($scope.progress);if($scope.downloaded==parseInt($scope.total)){localStorage.setItem('filesVersion',$scope.version);$location.path("/trainingDownload")}},function(fail){});model_DownloadFiles.createFile(def,dir,file.id,data)}).error(function(data,status){})})}});App.controller("ctrl_AchievmentShare",function($scope,$rootScope,$q,$routeParams,model_Share){$scope.title="Share";$scope.loading=!0;var def=$q.defer();def.promise.then(function(data){$scope.url=data.url;$scope.loading=!1});model_Share.shareAchivment(def,$routeParams.id);function successCallback(){$rootScope.goBack()}
function failCallback(){$scope.loading=!1;alertify.error("Failed to share achievement")}
$scope.fbShare=function(){$scope.loading=!0;window.plugins.socialsharing.shareViaFacebook('',null,$scope.url,successCallback,failCallback)}
$scope.twtShare=function(){$scope.loading=!0;window.plugins.socialsharing.shareViaTwitter('',null,$scope.url,successCallback,failCallback)};$scope.whatsappShare=function(){$scope.loading=!0;window.plugins.socialsharing.shareViaWhatsApp('',null,$scope.url,successCallback,failCallback)}
$scope.shareOther=function(){$scope.loading=!0;window.plugins.socialsharing.share('We have learned a new trick',null,null,$scope.url,successCallback,failCallback)}});App.controller("ctrl_SetupGoals",function($scope,$q,$location,$routeParams,model_Goal){$scope.type=$routeParams.type;$scope.title="Setup "+$routeParams.type+' goal';$scope.goal=model_Goal.getGoal($scope.type);console.log($scope.goal);if($scope.goal==null){console.log("inside");if($scope.type=="daily"){$scope.recommendedRepetitions=10}else{$scope.recommendedRepetitions=100}
$scope.decimalInput_DefaultValue=$scope.recommendedRepetitions}
if($scope.type=="daily"){$scope.message="How many repetitions you plan to do per day?"}else{$scope.message="how many repetitions you plan to do per week?"}
$scope.decimalInput_visible=!0;$scope.decimalInput_hideCancel=!0;$scope.decimalInput_save=function(){var newGoal=$('.decimalInputContainer .input').text();if(newGoal==''||parseInt(newGoal)==0){alertify.error("number not valid")}else{$scope.uploadGoal(newGoal)}}
$scope.uploadGoal=function(goal){var newGoal=parseInt(goal);console.log($scope.goal);$scope.decimalInput_reset();var def=$q.defer();def.promise.then(function(success){$scope.loading=!1;$scope.goal=newGoal;console.log(success.data);model_Goal.updateGoalsDataFromServer(success)},function(error){$scope.loading=!1;alertify.error("failed to load")});var data={goal:newGoal,type:$scope.type};model_Goal.updateGoal(def,data);$scope.loading=!0}
$scope.showInput=function(){$scope.decimalInput_visible=!0}});App.controller("ctrl_DailyGoals",function($scope,$q,$location,$routeParams,model_Goal,model_GoalDaily,model_GoalDetails){$scope.navigateBackBefore=function(){model_GoalDaily.clearFromTo()}
if(!window.localStorage.getItem('tutorialGoals')){$scope.goalsTutorialShow=!0}
$scope.closeTutorial=function(){$scope.goalsTutorialShow=!1;if($scope.goalsTutorial){window.localStorage.setItem('tutorialGoals','true')}}
$scope.clickedLabel=function(){$scope.goalsTutorial=!$scope.goalsTutorial};$scope.mainNav_settings_click=function(){console.log("click registered");model_GoalDaily.setFromTo($scope.from,$scope.to);$location.path('/goals/setup/daily')}
$scope.goal=model_Goal.getGoal('daily');$scope.title="Daily Goal: "+$scope.goal+' reps';var singleItemWidth=Math.floor(($('body').width()-7)/7);var onEdgeWidth=Math.floor(($('body').width()-singleItemWidth*7-7)/2)+singleItemWidth;console.log(onEdgeWidth);$scope.getDaysStyle=function(){return{width:singleItemWidth+'px'}}
$scope.getDotsStyle=function(day){var width;var bgColor;if(!day.borderDay){width=singleItemWidth}else{width=onEdgeWidth}
if(day.isBlank){bgColor='#ddd'}else if(day.dayPassed){bgColor='#bbbbbc'}else if(day.goalAchieved){bgColor='#2b8d28'}else if(day.trained){bgColor='#D4782C'}else{bgColor='#c84640'}
return{width:width+'px',backgroundColor:bgColor}}
$scope.getTotalWidth=function(){return{width:Math.floor(($('body').width())/7)*7}}
$scope.getData=function(){console.log("-----------------------------");console.log($scope.def);console.log("-----------------------------");if($scope.defNeedsReject){$scope.def.reject({canceled:!0})}
console.log($scope.from);console.log($scope.to);var data={from:kendo_DateHelper.getTimestampFromDate($scope.from.toDate()),to:kendo_DateHelper.getTimestampFromDate($scope.to.toDate()),goal:$scope.goal}
console.log(data);$scope.def=$q.defer();$scope.def.promise.then(function(data){console.log("daily goals got data");console.log(data);$scope.defNeedsReject=!1;var today=moment().endOf('day');for(var i=0;data.length>i;i++){var day=moment(data[i].date);if(day>today){data[i].dayPassed=!0}
var dayOfWeek=day.format('e');if(dayOfWeek==0||dayOfWeek==6){data[i].borderDay=!0}
if(data[i].total>0){data[i].trained=!0}}
var firstDay=moment(data[0].date).format('e');for(var i=firstDay;i>0;i--){var borderDay=!1;console.log(borderDay);if(i==1){borderDay=!0;console.log("border is true")}
var space={day:'',isBlank:!0,borderDay:borderDay};data.unshift(space)}
$scope.days=data},function(){});$scope.defNeedsReject=!0;model_GoalDaily.getGoalsDoneForMonth($scope.def,data)}
$scope.calculateArrows=function(){if(moment().endOf('month')<=$scope.to){$scope.arrowRight=!1}else{$scope.arrowRight=!0}};$scope.arrowLeftClick=function(){$scope.to=$scope.from.subtract(1,'seconds');$scope.from=moment($scope.to).startOf('month');$scope.currentMonth=$scope.from.format("MMMM");$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()}
$scope.arrowRightClick=function(){$scope.from=$scope.to.add(1,'seconds');$scope.to=moment($scope.to).endOf('month');$scope.currentMonth=$scope.from.format("MMMM");$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()}
$scope.dayClicked=function(day){if(day.isBlank){return null}
if(day.dayPassed){alertify.error("Future is yet to be trained");return null}
model_GoalDaily.setFromTo($scope.from,$scope.to);var month=$scope.currentMonth;var dayCurrent=day.day;var year=$scope.currentYear;day.title=dayCurrent+' '+month+', '+year;day.from=moment(day.date).startOf('day');day.to=moment(day.date).endOf('day');day.type='daily';day.trained=day.total;model_GoalDetails.setDetailsData(day);$location.path('/goals/details/')}
var fromTo=model_GoalDaily.getFromTo();console.log("--------");console.log(fromTo);console.log("----------");if(fromTo.from!==null&&fromTo.to!==null){$scope.from=fromTo.from;$scope.to=fromTo.to}else{$scope.from=moment().startOf('month');$scope.to=moment().endOf('month')}
$scope.arrowLeft=!0;$scope.arrowRight=!1;$scope.currentMonth=$scope.from.format("MMMM");$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()});App.controller("ctrl_DetailsGoals",function($scope,$q,$location,$routeParams,model_Goal,model_GoalDetails,stringHelper){$scope.day=model_GoalDetails.getDetailsData();console.log("----------------details");console.log($scope.day);$scope.title=$scope.day.title;$scope.goal=model_Goal.getGoal($scope.day.type);console.log($scope.goal);if($scope.day.trained){console.log("trained true");console.log($scope.day);$scope.goalTrained=!0;$scope.trainedReps=parseInt($scope.day.trained);$scope.trainedGoal=Math.ceil(($scope.trainedReps/$scope.goal)*100)}else{$scope.trainedReps=0;$scope.trainedGoal=0}
if($scope.day.goalAchieved){console.log("goalAchieved true");$scope.goalSuccess=!0}
data={from:kendo_DateHelper.getTimestampFromDate($scope.day.from.toDate()),to:kendo_DateHelper.getTimestampFromDate($scope.day.to.toDate()),};var def=$q.defer();var timeout;var shouldBlockNavigate=!1;def.promise.then(function(data){console.log("trick details data");console.log(data);for(var i=0;data.length>i;i++){data[i].trickName=stringHelper.formatWith3Dots(data[i].trickName,21,224,$('body').width()*0.7);data[i].percentGoal=Math.ceil((data[i].timesTrained/$scope.trainedReps)*100);data[i].successPercent=Math.ceil((data[i].timesSuccess/data[i].timesTrained)*100)}
$scope.tricks=data;console.log("is inside");var wrapper=document.getElementById('detailsGoalsScroller');$('#detailsGoalsScroller').css('height',$('body').height()-48);myScroll=new IScroll(wrapper,{useTransition:!0,preventDefault:!1});myScroll.on('scrollStart',function(){console.log("blocking");clearTimeout(timeout);shouldBlockNavigate=!0});myScroll.on('scrollEnd',function(){console.log("remove block");timeout=setTimeout(function(){shouldBlockNavigate=!1},100)});var statusHeigh=190;var tricksHeight=20+$scope.tricks.length*60;console.log("something");var totalHeight=statusHeigh+tricksHeight
console.log(totalHeight);myScroll.refresh(totalHeight,0);console.log(totalHeight);if(data.length==0){$scope.noTricksDone=!0}},function(){});$scope.calculateTrickWidth=function(trick){return{width:trick.successPercent+'%'}}
$scope.goToTrickStatistics=function(trick){console.log($scope.blockNavigate);if(shouldBlockNavigate){return null}
console.log(trick);$location.path('/statistics/trick/'+trick.trickId)}
model_GoalDetails.getTricksForPeriod(def,data)});App.controller("ctrl_WeeklyGoals",function($scope,$q,$location,$routeParams,model_Goal,model_GoalWeekly,model_GoalDetails){$scope.navigateBackBefore=function(){model_GoalWeekly.clearFromTo()}
if(!window.localStorage.getItem('tutorialGoals')){$scope.goalsTutorialShow=!0}
$scope.closeTutorial=function(){$scope.goalsTutorialShow=!1;if($scope.goalsTutorial){window.localStorage.setItem('tutorialGoals','true')}}
$scope.clickedLabel=function(){$scope.goalsTutorial=!$scope.goalsTutorial};$scope.mainNav_settings_click=function(){console.log("click registered");model_GoalWeekly.setFromTo($scope.from,$scope.to);$location.path('/goals/setup/weekly')}
$scope.goal=model_Goal.getGoal('weekly');$scope.title="Weekly Goal: "+$scope.goal+' reps';var singleItemWidth=Math.floor(($('body').width()-7)/7);var onEdgeWidth=Math.floor(($('body').width()-singleItemWidth*7-7)/2)+singleItemWidth;console.log(onEdgeWidth);$scope.getDaysStyle=function(){return{width:singleItemWidth+'px'}}
$scope.getDotsStyle=function(day){var width;var bgColor;if(!day.borderDay){width=singleItemWidth}else{width=onEdgeWidth}
if(day.isBlank){bgColor='#ddd'}else if(day.dayPassed){bgColor='#bbbbbc'}else if(day.goalAchieved){bgColor='#2b8d28'}else if(day.trained){bgColor='#D4782C'}else{bgColor='#c84640'}
return{width:width+'px',backgroundColor:bgColor}}
$scope.getTotalWidth=function(){return{width:Math.floor(($('body').width())/7)*7}}
$scope.getData=function(){console.log("-----------------------------");console.log($scope.def);console.log("-----------------------------");if($scope.defNeedsReject){$scope.def.reject({canceled:!0})}
var month=$scope.from.format('MM');var weeks=[];var firstWeek={};var start=moment($scope.from).startOf('week');firstWeek.from=kendo_DateHelper.getTimestampFromDate(start.toDate())
var end=moment($scope.from).endOf('week');firstWeek.to=kendo_DateHelper.getTimestampFromDate(end.toDate())
weeks.push(firstWeek);console.log(weeks);var newMonth=!1;while(!newMonth){var week={};start=end.add(1,'seconds');week.from=kendo_DateHelper.getTimestampFromDate(start.toDate());end=start.endOf('week');week.to=kendo_DateHelper.getTimestampFromDate(end.toDate());if(month!=start.format('MM')){newMonth=!0}
weeks.push(week)}
console.log(weeks);var data={weeks:weeks,goal:$scope.goal}
console.log(data.goal)
console.log(data);$scope.def=$q.defer();$scope.def.promise.then(function(data){console.log(data);$scope.defNeedsReject=!1;for(var i=0;data.length>i;i++){var from=moment(data[i].from);var to=moment(data[i].to);var fromMonth=from.format('MMM');var fromDay=from.format('D');var toMonth=to.format('MMM');var toDay=to.format('D');data[i].forShow=fromMonth+' '+fromDay+' - '+toMonth+' '+toDay;if(moment()<moment(data[i].from)){console.log("day has passed!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");console.log(data[i].to);data[i].dayPassed=!0}}
$scope.weeks=data},function(){});$scope.defNeedsReject=!0;model_GoalWeekly.getGoalsDoneForMonth($scope.def,data)}
$scope.calculateArrows=function(){if(moment().endOf('month')<=$scope.to){$scope.arrowRight=!1}else{$scope.arrowRight=!0}};$scope.arrowLeftClick=function(){$scope.to=$scope.from.subtract(1,'seconds');$scope.from=moment($scope.to).startOf('month');$scope.currentMonth=$scope.from.format("MMMM");console.log("-months are");console.log($scope.from);console.log($scope.to);$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()}
$scope.arrowRightClick=function(){$scope.from=$scope.to.add(1,'seconds');$scope.to=moment($scope.to).endOf('month');$scope.currentMonth=$scope.from.format("MMMM");$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()}
$scope.weekClicked=function(week){if(week.isBlank){return null}
if(week.dayPassed){alertify.error("Future is yet to be trained");return null}
console.log("---------------week");console.log(week);model_GoalWeekly.setFromTo($scope.from,$scope.to);var month=$scope.currentMonth;var year=$scope.currentYear;week.title=week.forShow;week.from=moment(week.from);week.to=moment(week.to);week.type='weekly';model_GoalDetails.setDetailsData(week);$location.path('/goals/details/')}
var fromTo=model_GoalWeekly.getFromTo();console.log("--------");console.log(fromTo);console.log("----------");if(fromTo.from!==null&&fromTo.to!==null){$scope.from=fromTo.from;$scope.to=fromTo.to}else{$scope.from=moment().startOf('month');$scope.to=moment().endOf('month')}
$scope.arrowLeft=!0;$scope.arrowRight=!1;$scope.currentMonth=$scope.from.format("MMMM");$scope.currentYear=$scope.from.year();$scope.calculateArrows();$scope.getData()});App.controller("ctrl_ServerUpload",function($scope,$q,$location,model_ServerSync,db_Sync,$rootScope){var def=$q.defer();def.promise.then(function(data){console.log("total rows:");console.log(data);var total=data.totalRows;console.log(total);var bufferSize=data.bufferSize;var uploaded=0;var totalTrainingsDone=[];$('#serverUploadProgress').html('0%');$('#serverUploadProgressBar').css('width','3%');var levels=[];var achievements=[];function uploadBuffer(offset){var def=$q.defer();def.promise.then(function(data){var defUpload=$q.defer();defUpload.promise.then(function(data){var defDelete=$q.defer();defDelete.promise.then(function(data){console.log("recieved data");console.log(data);uploaded=uploaded+bufferSize;console.log("uploaded total---------------");console.log(uploaded);console.log(total);if(uploaded>=total){uploaded=total;model_ServerSync.clearSyncNeeded();$location.path('/main')}else{uploadBuffer(uploaded)}
var percent=Math.round(uploaded/total)*100;$('#serverUploadProgress').html(percent+'%');$('#serverUploadProgressBar').css('width',percent+'%');levels.push(data.level);achievements.push(data.achivments)});model_ServerSync.deleteUploadedTraining(defDelete)});model_ServerSync.uploadTraining(defUpload,data)});console.log("getting training");console.log(uploaded);model_ServerSync.getTraining(def,0)}
uploadBuffer(0)});model_ServerSync.getTotalTrainings(def)});App.controller("ctrl_DownloadClicker",function($scope,$q,$location,$timeout,model_ServerSync,model_Level,db_Sync,$rootScope,model_Clicker,db_TrainingForServer,model_ResultUpload){$('#serverUploadProgress').html(0+'%');$('#serverUploadProgressBar').css('width',0+'%');var levels=[];var achievements=[];$scope.percentDone=0;$scope.startTestingTime=0;$scope.errors=[];$scope.tricksPassed=0;$scope.currentTestTrickId=1;var loggingTime={start:moment().unix()};function uploadPrevious(defUploadPrevious){if(navigator.connection.type!=Connection.NONE){var def=$q.defer();def.promise.then(function(data){var total=data.totalRows;var bufferSize=data.bufferSize;var uploaded=0;if(total==0){model_ServerSync.clearSyncNeeded();defUploadPrevious.resolve(!0);return null}
function uploadBuffer(offset){var def=$q.defer();def.promise.then(function(data){var defUpload=$q.defer();defUpload.promise.then(function(data){console.log("got data1........");console.log(data);var defDelete=$q.defer();defDelete.promise.then(function(data2){uploaded=uploaded+bufferSize;console.log("got data2........");console.log(data);if(data.level){levels.push(data.level)}
for(var i=0;i<data.achivments.length;i++){achievements.push(data.achivments[i])}
var percent=Math.round((uploaded/total)*50)+$scope.percentDone;if(percent>100){percent=100}
$('#serverUploadProgress').html(percent+'%');$('#serverUploadProgressBar').css('width',percent+'%');if(uploaded>=total){uploaded=total;model_ServerSync.clearSyncNeeded();var resultData={level:levels,achivments:achievements,tricks:$scope.bleApp.trickData,showSucessRates:!0};model_ResultUpload.setResult(resultData);$location.path('/resultUpload')}else{uploadBuffer(uploaded)}});model_ServerSync.deleteUploadedTraining(defDelete)});console.log("uploading trainings");console.log(data);model_ServerSync.uploadTraining(defUpload,data)});model_ServerSync.getTraining(def,0)}
uploadBuffer(0)});model_ServerSync.getTotalTrainings(def)}else{defUploadPrevious.reject(!0)}}
function downloadFromClicker(defSaved){var canelioIds=model_Clicker.getCanelioBLEIds();$scope.bleApp={timesReconnected:0,pointsData:{timesTrained:0,timesSuccess:0,},trickData:[],unixTimeLastSync:model_Clicker.getSyncTime(),bleEnabled:function(){if($scope.enableBluetoothWarning){$scope.$apply(function(){$scope.enableBluetoothWarning=!1})}
$scope.bleApp.scan()},bleDisabled:function(){if($scope.enableBluetoothWarning){alertify.error("Bluetooth still disabled")}
$scope.$apply(function(){$scope.enableBluetoothWarning=!0})},failedEnableAndroid:function(){$scope.$apply(function(){$scope.enableBluetoothWarning=!0})},checkBle:function(){ble.isEnabled($scope.bleApp.bleEnabled,$scope.bleApp.bleDisabled)},scan:function(){loggingTime.untilScann=moment().unix();var deviceName="Canelio"+model_Clicker.getS1();var found=!1;function onScan(peripheral){if(peripheral.name==deviceName){found=!0;$scope.bleApp.peripheralId=peripheral.id;ble.connect(peripheral.id,$scope.bleApp.onConnect,$scope.bleApp.onDisconnect);$timeout(function(){if(!$scope.bleApp.isConnected&&!$scope.bleApp.successConnecting){alertify.error("timeout expired disconnecting");ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail)}},10000,!0)}}
function scanFailure(reason){$scope.bleApp.reconnect()}
ble.scan([],5,onScan,scanFailure);$timeout(function(){if(!found){$scope.enableBluetoothTransferWarning=!0}},5000,!0)},onConnect:function(peripheral){loggingTime.untilConnect=moment().unix();$scope.bleApp.isConnected=!0;$scope.bleApp.successConnecting=!0;$scope.bleApp.firstConnect=!0;ble.startNotification(peripheral.id,canelioIds.service,canelioIds.measurement,$scope.bleApp.onData,$scope.bleApp.onErrorSendRecieve);function onWrite(){loggingTime.untilWrite=moment().unix()}
function onWriteFail(){console.log("written fail")}
var s2Time=model_Clicker.getS2AndHour();$scope.bleApp.timeForNextSync=s2Time.time;var data=new Uint8Array(s2Time.s2);console.log("sending data to clicker");console.log(data);ble.write($scope.bleApp.peripheralId,canelioIds.service,canelioIds.measurement,data.buffer,onWrite,$scope.bleApp.onErrorSendRecieve)},onDisconnect:function(reason){loggingTime.untilDisconnect=moment().unix();$scope.bleApp.isConnected=!1;if($scope.bleApp.dataTransferEnded){$scope.bleApp.saveTraining()}else{for(var i=0;$scope.bleApp.trickData.length>i;i++){$scope.bleApp.trickData[i].total=0;$scope.bleApp.trickData[i].success=0};$scope.bleApp.training=[];$scope.bleApp.pointsData.timesTrained=0;$scope.bleApp.pointsData.timesSuccess=0;$scope.bleApp.timesReconnected++;$scope.bleApp.checkIfReconnectOrWarning()}},checkIfReconnectOrWarning:function(){alertify.error("checkIfReconnectOrWarning");model_Clicker.setSyncRequired();if(!$scope.$$phase){$scope.$apply(function(){$location.path('/main')})}else{$location.path('/main')}},reconnect:function(){$scope.enableBluetoothTransferWarning=!1;$scope.enableBluetoothWarning=!1;$scope.bleApp.scan()},training:[],dataTransferEnded:!1,dcSuccess:function(){$scope.bleApp.isConnected=!1;$scope.bleApp.onDisconnect();if($scope.errors.length>0){console.log("errors are----------");console.log($scope.errors)}
if($scope.bleApp.training.length!=$scope.bleApp.totalTricksToRecieve){}},dcFail:function(){if($scope.bleApp.isConnected){ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail)}},doDc:function(){$scope.bleApp.dataTransferEnded=!0;ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail)},onData:function(buffer){var data=new Uint8Array(buffer);console.log(data);if($scope.bleApp.firstConnect){$scope.bleApp.firstConnect=!1;$scope.bleApp.totalTricksToRecieve=data[0]*256+data[1];return null}
var position=0;var tricks=[];for(var i=0;i<data.length;i=i+7){$scope.tricksPassed++;if(data[i]==0&&data[i+1]==0&&data[i+2]==0&&data[i+3]==0&&data[i+4]==0){console.log("data before dc");console.log(data);setTimeout($scope.bleApp.doDc,500);break}
console.log("check this out");console.log(data[i]);console.log(data[i+1]);var trick={timesSuccess:data[i]+data[i+1]*256,timesTrained:data[i+2]+data[i+3]*256,time:data[i+4]+data[i+5]*256,trick_id:data[i+6]}
console.log(trick.trick_id)
console.log("tricks is");console.log(trick)
trick.time=trick.time*3600+$scope.bleApp.unixTimeLastSync;if((trick.trick_id-1)<$scope.bleApp.trickData.length){if(trick.timesSuccess>trick.timesTrained){trick.timesSuccess=Math.round(trick.timesTrained/2)}
console.log($scope.bleApp.trickData[trick.trick_id-1].total);console.log($scope.bleApp.trickData[trick.trick_id-1].success);$scope.bleApp.trickData[trick.trick_id-1].total=$scope.bleApp.trickData[trick.trick_id-1].total+trick.timesTrained;$scope.bleApp.trickData[trick.trick_id-1].success=$scope.bleApp.trickData[trick.trick_id-1].success+trick.timesSuccess;console.log($scope.bleApp.trickData[trick.trick_id-1].total);console.log($scope.bleApp.trickData[trick.trick_id-1].success);trick.trick_id=$scope.bleApp.trickData[trick.trick_id-1].id;console.log("after id fail");$scope.bleApp.pointsData.timesTrained=$scope.bleApp.pointsData.timesTrained+parseInt(trick.timesTrained);$scope.bleApp.pointsData.timesSuccess=$scope.bleApp.pointsData.timesSuccess+parseInt(trick.timesSuccess);$scope.bleApp.training.push(trick)}}
if($scope.bleApp.totalTricksToRecieve==0){$('#serverUploadProgress').html(50+'%');$('#serverUploadProgressBar').css('width',50+'%')}else{$scope.percentDone=Math.round(($scope.tricksPassed/$scope.bleApp.totalTricksToRecieve)*50);$('#serverUploadProgress').html($scope.percentDone+'%');$('#serverUploadProgressBar').css('width',$scope.percentDone+'%')}},saveTraining:function(){var def=$q.defer();model_Level.updatePoints($scope.bleApp.pointsData);def.promise.then(function(data){var time=model_Clicker.getSyncTime();model_ServerSync.updateSync(time,!1);model_Clicker.resetSyncTime();loggingTime.untilDbSaved=moment().unix();model_Clicker.saveSyncTime($scope.bleApp.timeForNextSync);model_Clicker.clearSyncRequired();defSaved.resolve(!0)});db_TrainingForServer.insertTraining(def,$scope.bleApp.training);var defLocalSave=$q.defer();model_Clicker.saveTraining(defLocalSave,$scope.bleApp.training)},onErrorSendRecieve:function(reason){alertify.error("Error getting data please retry connecting to clicker");$scope.bleApp.dcFail()},cancelSync:function(){alertify.success("You can always sync clicker from settings");model_Clicker.setSyncRequired();$location.path('/main')}};var defTricks=$q.defer();defTricks.promise.then(function(data){$scope.bleApp.tricks=[];$scope.bleApp.trickData=data;for(var i=0;$scope.bleApp.trickData.length>i;i++){$scope.bleApp.trickData[i].total=0;$scope.bleApp.trickData[i].success=0};$scope.bleApp.checkBle()});model_Clicker.getFirstFiveTricks(defTricks)}
$scope.checkBleButton=function(){scope.bleApp.checkBle()}
$('#clickerUploadProgress').html('5%');$('#clickerUploadProgressBar').css('width','5%');var defDownloadClicker=$q.defer();defDownloadClicker.promise.then(function(data){console.log("download passedddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd")
var uploadNeeded=model_ServerSync.isSyncNeeded();if(uploadNeeded){var defUpload=$q.defer();defUpload.promise.then(function(data){$location.path('/main')},function(error){alertify.error("Connect to internet to get levels and achievements");$location.path('/main')});uploadPrevious(defUpload)}});downloadFromClicker(defDownloadClicker)});App.controller("ctrl_DownloadTraining",function($scope,model_DownloadFiles,$q,$routeParams,db_Manager,$cordovaFile,$location,model_ServerSync,model_Tricks){var trainingsDownloaded=!1;var tricksDownloaded=!1;var def=$q.defer();def.promise.then(function(data){var def=$q.defer();def.promise.then(function(data){var total=data.count;var bufferSize=data.bufferSize;var uploaded=0;$('#downloadTrainingProgressPercentage').html('0%');$('#downloadTrainingProgressBar').css('width','3%');function uploadBuffer(offset){var def=$q.defer();def.promise.then(function(data){console.log("before saving");var defSave=$q.defer();defSave.promise.then(function(data){uploaded=uploaded+bufferSize;if(uploaded>=total){uploaded=total;trainingsDownloaded=!0;console.log("downloaded........")
if(trainingsDownloaded&&tricksDownloaded){$location.path('/clicker/Connect')}}
if(total!=0){var percent=Math.round(uploaded/total)*100}else{var percent=100}
$('#downloadTrainingProgressPercentage').html(percent+'%');$('#downloadTrainingProgressBar').css('width',percent+'%');if(uploaded<total){console.log("calling itself..........")
uploadBuffer(uploaded)}});model_ServerSync.saveTrainingsToDb(defSave,data)});model_ServerSync.getTrainingsServer(def,{offset:uploaded,bufferSize:bufferSize})}
uploadBuffer(0)});model_ServerSync.getTotalTrainingsServer(def)});db_Manager.createTables(def);var def2=$q.defer();def2.promise.then(function(data){console.log("got tricks from server");var def=$q.defer();def.promise.then(function(){tricksDownloaded=!0;console.log("def resolved");console.log(trainingsDownloaded);console.log(tricksDownloaded);if(trainingsDownloaded&&tricksDownloaded){$location.path('/main')}});model_Tricks.saveTricks(def,data)});model_Tricks.getTricksFromServer(def2,{})});App.controller("ctrl_ClickerConnect",function($scope,$q,$timeout,$location,model_Clicker){$scope.step=1;$scope.cancelClickerConnect=function(){$location.path('/main')}
$scope.securityConnect=function(){if($scope.clickerCode==''||$scope.clickerCode==null){alertify.error("Please enter the code")}else{$scope.tryConnect()}}
$scope.tryConnect=function(){var data={userInput:$scope.clickerCode};var def=$q.defer();def.promise.then(function(success){console.log(success);$scope.s1=success.s1;$scope.s2=success.s2;$scope.s2original=[];$.extend(!0,$scope.s2original,success.s2);var time=model_Clicker.getMinutesSecondsToFullHour();$scope.time=time.time;$scope.s2.push(time.m);$scope.s2.push(time.s);$scope.s2.push(0,0);console.log($scope.s2);$scope.checkForClicker()},function(error){alertify.error(error.message)});model_Clicker.connectS3(def,data)}
$scope.goToStep2AndClear=function(){$scope.enableBluetoothTransferWarning=!1;$scope.enableBluetoothWarning=!1;alertify.error("there was error connecting to clicker");$scope.step=2;$scope.clickerCode=null}
$scope.checkForClicker=function(){$scope.step=3;var canelioIds=model_Clicker.getCanelioBLEIds();$scope.bleApp={timesReconnected:0,pointsData:{timesTrained:0,timesSuccess:0,},unixTimeLastSync:model_Clicker.getSyncTime(),bleEnabled:function(){if($scope.enableBluetoothWarning){$scope.$apply(function(){$scope.enableBluetoothWarning=!1})}
$scope.bleApp.scan()},bleDisabled:function(){if($scope.enableBluetoothWarning){alertify.error("Bluetooth still disabled")}
$scope.$apply(function(){$scope.enableBluetoothWarning=!0})},failedEnableAndroid:function(){$scope.$apply(function(){$scope.enableBluetoothWarning=!0})},checkBle:function(){ble.isEnabled($scope.bleApp.bleEnabled,$scope.bleApp.bleDisabled)},scan:function(){var deviceName="Canelio"+$scope.s1;var found=!1;function onScan(peripheral){if(peripheral.name==deviceName){found=!0;ble.connect(peripheral.id,$scope.bleApp.onConnect,$scope.bleApp.onDisconnect);$timeout(function(){if(!$scope.bleApp.isConnected&&!$scope.bleApp.successConnecting){alertify.error("timeout expired disconnecting");ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail)}},10000,!0)}}
function scanFailure(reason){alertify.error("scan failed");$scope.bleApp.scan()}
ble.scan([],5,onScan,scanFailure);$timeout(function(){if(!found){$scope.enableBluetoothTransferWarning=!0}},5000,!0)},stopScanFailed:function(){ble.stopScan($scope.bleApp.stopScanSuccess,$scope.bleApp.stopScanFailed)},stopScanSuccess:function(){alertify.success("succes stop scan")},reconnect:function(){$scope.enableBluetoothTransferWarning=!1;$scope.enableBluetoothWarning=!1;$scope.bleApp.scan()},onConnect:function(peripheral){$scope.bleApp.isConnected=!0;$scope.bleApp.successConnecting=!0;$scope.bleApp.peripheralId=peripheral.id;console.log("connnected");alertify.success("connected");console.log($scope.s2);ble.startNotification(peripheral.id,canelioIds.service,canelioIds.measurement,$scope.bleApp.onData,$scope.bleApp.onErrorSendRecieve);function onWrite(){}
var data=new Uint8Array($scope.s2);ble.write($scope.bleApp.peripheralId,canelioIds.service,canelioIds.measurement,data.buffer,onWrite,$scope.bleApp.onErrorSendRecieve)},onDisconnect:function(reason){$scope.bleApp.isConnected=!1;if($scope.bleApp.dataTransferEnded){$scope.bleApp.saveTraining()}else{$scope.bleApp.training=[];$scope.bleApp.pointsData.timesTrained=0;$scope.bleApp.pointsData.timesSuccess=0;$scope.bleApp.checkIfReconnectOrWarning()}},checkIfReconnectOrWarning:function(){alertify.error("Something went wrong");$scope.goToStep2AndClear()},training:[],dataTransferEnded:!1,dcSuccess:function(){$scope.bleApp.isConnected=!1;$scope.bleApp.onDisconnect();$location.path('/main')},dcFail:function(){if($scope.bleApp.isConnected){ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail)}},onData:function(buffer){console.log("got data");var data=new Uint8Array(buffer);console.log(data);var position=0;var tricks=[];for(var i=0;i<20;i=i+5){if(data[i]==0&&data[i+1]==0&&data[i+2]==0&&data[i+3]==0&&data[i+4]==0){$scope.bleApp.dataTransferEnded=!0;ble.disconnect($scope.bleApp.peripheralId,$scope.bleApp.dcSuccess,$scope.bleApp.dcFail);break}}},saveTraining:function(){console.log("should save training");var def=$q.defer();def.promise.then(function(success){var data={s1:$scope.s1,s2:$scope.s2original,time:$scope.time,};model_Clicker.saveClicker(data);$location.path('/main')},function(error){$scope.goToStep2AndClear()});var data={s3:$scope.clickerCode,s2:$scope.s2original,s1:$scope.s1,};console.log("senidnig data");console.log(data);model_Clicker.claimClicker(def,data)},onErrorSendRecieve:function(reason){alertify.error("error getting data please retry connecting to clicker");$scope.bleApp.dcFail();$scope.goToStep2AndClear()},};$scope.bleApp.checkBle()}});App.controller("ctrl_RequestPassword",function($scope,$q,model_Login,$location,$rootScope,svc_FileChecker,model_Register){$scope.step=0;$scope.sendEmail=function(){if($scope.email==''||$scope.email==null){alertify.error('Please input your email')}
var def=$q.defer();def.promise.then(function(data){$scope.step=2},function(){alertify.error("Inputed wrong email");$scope.email=''});model_Register.resetPassword(def,{email:$scope.email})}
$scope.back=function(){$rootScope.goBack()}});App.controller("ctrl_LevelDetails",function($scope,$q,$location,model_Dog,model_Level){$scope.title='Ranking Title';model_Dog.getDogImage().then(function(src){console.log(src);if(src!=null){$scope.dogImage=src}},function(error){});var lvlPoints=model_Level.getLevelPoints();console.log(lvlPoints);$scope.level=lvlPoints.lvl;$scope.rankingTitle=lvlPoints.title});App.controller("ctrl_ResultUpload",function($scope,$q,$location,model_Dog,model_Level,model_ResultUpload,stringHelper){$scope.totalSteps=0;var results=model_ResultUpload.getResult();$scope.step=results.step;console.log("inside result upload");console.log($scope.step);$scope.successRatesExists=results.showSucessRates;if($scope.successRatesExists){$scope.totalSteps++}
$scope.lvlsWonExists=!1;if(results.lvlsWon!=0){$scope.totalSteps++;$scope.lvlsWonExists=!0}
$scope.achivementsWonExists=!1;if(results.achivmentsTotal!=0){$scope.totalSteps++;$scope.achivementsWonExists=!0;console.log("it exists");console.log($scope.achivementsWonExists)}
if($scope.step==0){if($scope.lvlsWonExists){$scope.step=1}else if($scope.achivementsWonExists){$scope.step=2}else{$scope.step=3}}
for(var i=0;i<results.achivementsWon.length;i++){results.achivementsWon[i].trick=stringHelper.formatWith3Dots(results.achivementsWon[i].trick,18,320,320)}
$scope.achivmentClicked=function(a){console.log(a);var config={trickId:a.trickId,achivmentId:a.achivmentId,type:'resultSync'};kmodel_UploadDogImage.setConfig(config);$location.path('/achievementWon/'+a.trickId+'/'+a.achivmentId)}
console.log("step and totalsteps");console.log($scope.step);console.log($scope.totalSteps);model_Dog.getDogImage().then(function(src){console.log(src);if(src!=null){$scope.dogImage=src}},function(error){});var lvlPoints=model_Level.getLevelPoints();console.log(lvlPoints);$scope.level=results.lvl;$scope.rankingTitle=results.title;$scope.lvlsWon=results.lvlsWon;$scope.titleWon=results.titleWon;$scope.achivmentsTotal=results.achivmentsTotal;$scope.achivementsWon=results.achivementsWon;var wrapper=document.getElementById('achivmentsContainer');var totalHeight=170+30+120*results.achivementsWon.length;$('#achivmentsContainer').css('height',$('body').height()-48);myScroll=new IScroll(wrapper,{useTransition:!0,preventDefault:!1});myScroll.refresh(totalHeight,0);var scrollProgress=!1;$scope.$on('$viewContentLoaded',function(){console.log("inside 1231--------");$($scope.achivementsWon).each(function(index,el){console.log("inside 123--------");var text='<div class="singleAchivment" trickid="'+el.trickId+'"achivmentid="'+el.achivmentId+'">'+'<div class="width320 relativeContainer"><img class="profileImg" src="'+el.img+'"/><div class="trickTitle">'+el.trick+'</div></div></div>';$('.resultUploadAchivmentList').append(text)});$('#resultUploadAchivmentList .singleAchivment').on('click',function(e){console.log("click recieved");if(!scrollProgress){var trickId=$(this).attr('trickid');var achivmentId=$(this).attr('achivmentid');var config={trickId:trickId,achivmentId:achivmentId,type:'resultSync'};for(var i=0;$scope.achivementsWon.length>i;i++){if($scope.achivementsWon[i].trickId==config.trickId){if($scope.achivementsWon[i].hasImg){kmodel_UploadDogImage.setImages($scope.achivementsWon[i].img,null)}}}
model_ResultUpload.setStep($scope.step);$scope.$apply(function(){$location.path('/achievementWon/'+trickId+'/'+achivmentId)})}})});myScroll.on('scrollStart',function(){scrollProgress=!0})
myScroll.on('scrollEnd',function(){scrollProgress=!1})
$scope.goNextPage=function(){if($scope.step==1){if($scope.achivementsWonExists){$scope.step=2}else if($scope.successRatesExists){$scope.step=3}
return null}
if($scope.step==2){if($scope.successRatesExists){$scope.step=3}
return null}}
$scope.goBackStep=function(){if($scope.step==3){console.log($scope.step);if($scope.achivementsWonExists){console.log($scope.step);$scope.step=2;console.log($scope.step)}else{console.log("in else");$scope.step=1}
return null}
if($scope.step==2){if($scope.lvlsWonExists){$scope.step=1}
return null}}
$scope.close=function(){kmodel_UploadDogImage.resetImages();model_ResultUpload.clearFromResultUpload();$location.path('/main')}
$scope.tricks=results.tricks;$scope.totalReps=0;for(var i=0;i<$scope.tricks.length;i++){$scope.totalReps=$scope.totalReps+parseInt($scope.tricks[i].total)}
$scope.calculateTrickWidth=function(trick){if(trick.total==0){return{width:'0%'}}else{return{width:Math.round((trick.success/trick.total)*100)+'%'}}}
$scope.calculateSuccessRate=function(trick){return Math.round((trick.success/trick.total)*100)}
$scope.goToTrickStatistics=function(trick){console.log(trick);model_ResultUpload.setStep(3);$location.path('/statistics/trick/'+trick.id)}
console.log(results.achivmentsTotal);console.log(results)});App.controller("ctrl_SingleAchivment",function($scope,$q,$routeParams,db_Trainig,stringHelper,model_Tricks,$location){console.log("iside single achivment");$scope.title=$routeParams.trickName;$scope.trickId=$routeParams.trickId;$scope.name=$routeParams.trickName;console.log("trick id is");console.log($scope.trickId);var defStats=$q.defer();defStats.promise.then(function(trick){console.log("trick is");console.log(trick);if(trick.timesTrained==null){trick.timesTrained=100}
if(trick.timesSuccess==null){trick.timesSuccess=50}
$scope.success=Math.round((trick.timesSuccess/trick.timesTrained)*100);$scope.fail=100-$scope.success});db_Trainig.getTrickTotal(defStats,{trickId:$scope.trickId});var def2=$q.defer();def2.promise.then(function(data){$scope.achivmentLevel=data.level;$scope.fulltitle=kmodel_Achivement.getTitleForLevel($scope.achivmentLevel,$scope.title);console.log($scope.fulltitle);$scope.achivmentTitle=stringHelper.formatWith3Dots($scope.fulltitle,25,320,$('body').width());if($scope.achivmentLevel==1){$scope.trophy1='res/trophies/trophy1.png'}else if($scope.achivmentLevel==2){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png'}else if($scope.achivmentLevel==3){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png';$scope.trophy3='res/trophies/trophy3.png'}else if($scope.achivmentLevel==4){$scope.trophy1='res/trophies/trophy1.png';$scope.trophy2='res/trophies/trophy2.png';$scope.trophy3='res/trophies/trophy3.png';$scope.trophy4='res/trophies/trophy4.png'}},function(data){$scope.goOffline=!0});var data={trickId:$scope.trickId};kmodel_Achivement.achivmentLevel(def2,data);var def3=$q.defer();def3.promise.then(function(data){console.log(data);if(data.hasImage){$scope.imageSrc=data.imageSrc}});var dataTrick={trickId:$scope.trickId};model_Tricks.getTrickImage(def3,dataTrick);var defAchId=$q.defer();defAchId.promise.then(function(data){$scope.achivmentId=data;console.log("achivment id is",$scope.achivmentId)});var dataTrickID={trickId:$scope.trickId};kmodel_Achivement.getAchivmentId(defAchId,dataTrickID);$scope.shareAchivment=function(){var url='/share/achievmenet/'+$scope.trickId;$location.path(url)}})